"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8155],{80418:function(e,t,i){i.d(t,{M:function(){return Editor}});var s,r,n,a,h,o,l,d,p,g,u,c,S,f,m,y,_,P,I,C,w,b,T,B,F,E,v,k,A,M,O,U,R,L,K,z,V,D,G,H,Z,N,Y,X,W,q,j,Q,$,J,ee,et,ei,es,er,en,ea,eh,eo,el,ed,ep,eg,eu,ec,eS,ef,em,ey,e_,eP,eI,eC,ew,ex,eb=i(31316),eT=i(63134),eB=i(43001),eF=i(70938),eE=i(79534),ev=i(84995),ek=i(7217),eA=i(46072),eM=i(29968),eO=i(57655),eU=i(49140),eR=i(12968),eL=i(49894),eK=i(18817),ez=i(90975),eV=i(25485),eD=i(30696),eG=i(45404),eH=i(14204),eZ=i(31986),eN=i(87684),eY=i(30224),eX=i(46166),eW=i(9006),eq=i(20047),ej=i(50280),eQ=i(16384),e$=i(10966),eJ=i(41605),e0=i(25689),e1=i(10853),e2=i(17556),e5=i(79334),e4=i(43067),e8=i(69078),e6=i(94211),e3=i(75650),e7=i(22784),e9=i(85241),te=i(36290),tt=i(42072),ti=i(12275),ts=i(57258),tr=i(48568),tn=i(8728),ta=i(5462),th=i(59040),to=Object.create,tl=Object.defineProperty,td=Object.getOwnPropertyDescriptor,__knownSymbol=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),__typeError=e=>{throw TypeError(e)},__defNormalProp=(e,t,i)=>t in e?tl(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,__name=(e,t)=>tl(e,"name",{value:t,configurable:!0}),tp=["class","method","getter","setter","accessor","field","value","get","set"],__expectFn=e=>void 0!==e&&"function"!=typeof e?__typeError("Function expected"):e,__decoratorContext=(e,t,i,s,r)=>({kind:tp[e],name:t,metadata:s,addInitializer:e=>i._?__typeError("Already initialized"):r.push(__expectFn(e||null))}),__decoratorMetadata=(e,t)=>__defNormalProp(t,__knownSymbol("metadata"),e[3]),__runInitializers=(e,t,i,s)=>{for(var r=0,n=e[t>>1],a=n&&n.length;r<a;r++)1&t?n[r].call(i):s=n[r].call(i,s);return s},__decorateElement=(e,t,i,s,r,n)=>{var a,h,o,l,d,p=7&t,g=!!(8&t),u=!!(16&t),c=p>3?e.length+1:p?g?1:2:0,S=tp[p+5],f=p>3&&(e[c-1]=[]),m=e[c]||(e[c]=[]),y=p&&(u||g||(r=r.prototype),p<5&&(p>3||!u)&&td(p<4?r:{get[i](){return __privateGet(this,n)},set[i](x){return __privateSet(this,n,x)}},i));p?u&&p<4&&__name(n,(p>2?"set ":p>1?"get ":"")+i):__name(r,i);for(var _=s.length-1;_>=0;_--)l=__decoratorContext(p,i,o={},e[3],m),p&&(l.static=g,l.private=u,d=l.access={has:u?e=>__privateIn(r,e):e=>i in e},3^p&&(d.get=u?e=>(1^p?__privateGet:__privateMethod)(e,r,4^p?n:y.get):e=>e[i]),p>2&&(d.set=u?(e,t)=>__privateSet(e,r,t,4^p?n:y.set):(e,t)=>e[i]=t)),h=(0,s[_])(p?p<4?u?n:y[S]:p>4?void 0:{get:y.get,set:y.set}:r,l),o._=1,4^p||void 0===h?__expectFn(h)&&(p>4?f.unshift(h):p?u?n=h:y[S]=h:r=h):"object"!=typeof h||null===h?__typeError("Object expected"):(__expectFn(a=h.get)&&(y.get=a),__expectFn(a=h.set)&&(y.set=a),__expectFn(a=h.init)&&f.unshift(a));return p||__decoratorMetadata(e,r),y&&tl(r,i,y),u?4^p?n:y:r},__publicField=(e,t,i)=>__defNormalProp(e,"symbol"!=typeof t?t+"":t,i),__accessCheck=(e,t,i)=>t.has(e)||__typeError("Cannot "+i),__privateIn=(e,t)=>Object(t)!==t?__typeError('Cannot use the "in" operator on this value'):e.has(t),__privateGet=(e,t,i)=>(__accessCheck(e,t,"read from private field"),i?i.call(e):t.get(e)),__privateSet=(e,t,i,s)=>(__accessCheck(e,t,"write to private field"),s?s.call(e,i):t.set(e,i),i),__privateMethod=(e,t,i)=>(__accessCheck(e,t,"access private method"),i);let Editor=class Editor extends(ew=eE,eC=[eb.Fl],eI=[eb.Fl],eP=[eb.Fl],e_=[eb.Fl],ey=[eb.Fl],em=[eb.Fl],ef=[eb.Fl],eS=[eb.Fl],ec=[eb.Fl],eu=[eb.Fl],eg=[eb.Fl],ep=[eb.Fl],ed=[eb.Fl],el=[eb.Fl],eo=[eb.Fl],eh=[eb.Fl],ea=[eb.Fl],en=[eb.Fl],er=[eb.Fl],es=[eb.Fl],ei=[eb.Fl],et=[eb.Fl],ee=[eb.Fl],J=[eb.Fl],$=[eb.Fl],Q=[eb.Fl],j=[eb.Fl],q=[eb.Fl],W=[eb.Fl],X=[eb.Fl],Y=[eb.Fl],N=[eb.Fl],Z=[eb.Fl],H=[eb.Fl],G=[eb.Fl],D=[eb.Fl],V=[eb.Fl],z=[eb.Fl],K=[eb.Fl],L=[eb.Fl],R=[eb.Fl],U=[eb.Fl],O=[eb.Fl],M=[eb.Fl],A=[eb.Fl],k=[eb.Fl],v=[eb.Fl],E=[eb.Fl],F=[eb.Fl],B=[eb.Fl],T=[eb.Fl],b=[eb.Fl],w=[eb.Fl],C=[eb.Fl],I=[eb.Fl],P=[eb.Fl],_=[eb.Fl],y=[eb.Fl],m=[eb.Fl],f=[eb.Fl],S=[eb.Fl],c=[eb.Fl],u=[eb.Fl],g=[eb.Fl],p=[eb.Fl],d=[(0,eb.Fl)({isEqual:(e,t)=>e.equals(t)})],l=[eb.Fl],o=[eb.Fl],h=[eb.Fl],a=[eF.ak],n=[eF.ak],r=[eF.ak],s=[eF.ak],ew){constructor({store:e,user:t,shapeUtils:i,bindingUtils:s,tools:r,getContainer:n,cameraOptions:a,textOptions:h,initialState:o,autoFocus:l,inferDarkMode:d,options:p,isShapeHidden:g,getShapeVisibility:u,fontAssetUrls:c}){super(),__runInitializers(ex,5,this),__publicField(this,"id",(0,eF.EL)()),__publicField(this,"_getShapeVisibility"),__publicField(this,"options"),__publicField(this,"contextId",(0,eF.EL)()),__publicField(this,"store"),__publicField(this,"root"),__publicField(this,"disposables",new Set),__publicField(this,"isDisposed",!1),__publicField(this,"_tickManager"),__publicField(this,"snaps"),__publicField(this,"timers",ez.r.forContext(this.contextId)),__publicField(this,"user"),__publicField(this,"textMeasure"),__publicField(this,"fonts"),__publicField(this,"environment",eL.a),__publicField(this,"scribbles"),__publicField(this,"sideEffects"),__publicField(this,"edgeScrollManager"),__publicField(this,"focusManager"),__publicField(this,"getContainer"),__publicField(this,"shapeUtils"),__publicField(this,"styleProps"),__publicField(this,"bindingUtils"),__publicField(this,"history"),__publicField(this,"_shouldIgnoreShapeLock",!1),__publicField(this,"_crashingError",null),__publicField(this,"_isChangingStyleTimeout",-1),__publicField(this,"menus",eK.h.forContext(this.contextId)),__publicField(this,"_currentRichTextEditor",(0,eb.cn)("rich text editor",null)),__publicField(this,"_textOptions"),__publicField(this,"_cameraOptions",(0,eb.cn)("camera options",eO.B8)),__publicField(this,"_viewportAnimation",null),__publicField(this,"_willSetInitialBounds",!0),__publicField(this,"_isLockedOnFollowingUser",(0,eb.cn)("isLockedOnFollowingUser",!1)),__publicField(this,"_cameraState",(0,eb.cn)("camera state","idle")),__publicField(this,"_cameraStateTimeoutRemaining",0),__publicField(this,"_currentPageShapeIds"),__publicField(this,"_shapeGeometryCaches",{}),__publicField(this,"_notVisibleShapes",(0,e4.A)(this)),__publicField(this,"_parentIdsToChildIds"),__publicField(this,"animatingShapes",new Map),__publicField(this,"externalAssetContentHandlers",{file:null,url:null}),__publicField(this,"temporaryAssetPreview",new Map),__publicField(this,"externalContentHandlers",{text:null,files:null,"file-replace":null,embed:null,"svg-text":null,url:null,tldraw:null,excalidraw:null}),__publicField(this,"inputs",{originPagePoint:new eH.B,originScreenPoint:new eH.B,previousPagePoint:new eH.B,previousScreenPoint:new eH.B,currentPagePoint:new eH.B,currentScreenPoint:new eH.B,keys:new Set,buttons:new Set,isPen:!1,shiftKey:!1,metaKey:!1,ctrlKey:!1,altKey:!1,isDragging:!1,isPointing:!1,isPinching:!1,isEditing:!1,isPanning:!1,isSpacebarPanning:!1,pointerVelocity:new eH.B}),__publicField(this,"_clickManager",new e3.o(this)),__publicField(this,"_prevCursor","default"),__publicField(this,"_shiftKeyTimeout",-1),__publicField(this,"_altKeyTimeout",-1),__publicField(this,"_ctrlKeyTimeout",-1),__publicField(this,"_metaKeyTimeout",-1),__publicField(this,"_restoreToolId","select"),__publicField(this,"_pinchStart",1),__publicField(this,"_didPinch",!1),__publicField(this,"_selectedShapeIdsAtPointerDown",[]),__publicField(this,"_longPressTimeout",-1),__publicField(this,"capturedPointerId",null),__publicField(this,"performanceTracker"),__publicField(this,"performanceTrackerTimeout",-1),__publicField(this,"_pendingEventsForNextTick",[]),(0,eF.hu)(!(g&&u),"Cannot use both isShapeHidden and getShapeVisibility"),this._getShapeVisibility=g?(e,t)=>g(e,t)?"hidden":"inherit":u,this.options={...eV.a,...p},this.store=e,this.history=new tt.E({store:e,annotateError:e=>{this.annotateError(e,{origin:"history.batch",willCrashApp:!0}),this.crash(e)}}),this.snaps=new ts.f(this),this.disposables.add(this.timers.dispose),this._cameraOptions.set({...eO.B8,...a}),this._textOptions=(0,eb.cn)("text options",h??null),this.user=new ta.K(t??(0,ek.L)(),d??!1),this.disposables.add(()=>this.user.dispose()),this.getContainer=n,this.textMeasure=new tr.R(this),this.disposables.add(()=>this.textMeasure.dispose()),this.fonts=new te.Q(this,c),this._tickManager=new tn.r(this);let NewRoot=class NewRoot extends th.m{static initial=o??""};this.root=new NewRoot(this),this.root.children={};let S=(0,eM.m)(i),f={},m={},y=new Map;for(let e of S){let t=new e(this);f[e.type]=t;let i=(0,eB.DR)(e.props??{});for(let t of(m[e.type]=i,i.keys()))if(y.has(t.id)){if(y.get(t.id)!==t)throw Error(`Multiple style props with id "${t.id}" in use. Style prop IDs must be unique.`)}else y.set(t.id,t)}this.shapeUtils=f,this.styleProps=m;let _=(0,eA.c)(s),P={};for(let e of _){let t=new e(this);P[e.type]=t}for(let e of(this.bindingUtils=P,[...r])){if((0,eF.nr)(this.root.children,e.id))throw Error(`Can't override tool with id "${e.id}"`);this.root.children[e.id]=new e(this,this.root)}this.scribbles=new ti.o(this);let cleanupInstancePageState=(e,t)=>{let i=null,s=e.selectedShapeIds.filter(e=>!t.has(e));s.length!==e.selectedShapeIds.length&&(i||(i={...e}),i.selectedShapeIds=s);let r=e.erasingShapeIds.filter(e=>!t.has(e));r.length!==e.erasingShapeIds.length&&(i||(i={...e}),i.erasingShapeIds=r),e.hoveredShapeId&&t.has(e.hoveredShapeId)&&(i||(i={...e}),i.hoveredShapeId=null),e.editingShapeId&&t.has(e.editingShapeId)&&(i||(i={...e}),i.editingShapeId=null);let n=e.hintingShapeIds.filter(e=>!t.has(e));return n.length!==e.hintingShapeIds.length&&(i||(i={...e}),i.hintingShapeIds=n),e.focusedGroupId&&t.has(e.focusedGroupId)&&(i||(i={...e}),i.focusedGroupId=null),i};this.sideEffects=this.store.sideEffects;let I=new Map,C=new Set,w=new Set,b=new Set;if(this.disposables.add(this.sideEffects.registerOperationCompleteHandler(()=>{for(let e of(C.clear(),w)){w.delete(e);let t=this.getShape(e);if(!t)continue;let i=this.getShapeUtil(t),s=i.onChildrenChange?.(t);s?.length&&this.updateShapes(s)}if(b.size){let e=b;for(let t of(b=new Set,e)){let e=this.getBindingUtil(t);e.onOperationComplete?.()}}if(I.size){let e=I;for(let t of(I=new Map,e.values()))this.getBindingUtil(t.binding).onAfterDelete?.(t)}this.emit("update")})),this.disposables.add(this.sideEffects.register({shape:{afterChange:(e,t)=>{for(let i of this.getBindingsInvolvingShape(t))b.add(i.type),i.fromId===t.id&&this.getBindingUtil(i).onAfterChangeFromShape?.({binding:i,shapeBefore:e,shapeAfter:t,reason:"self"}),i.toId===t.id&&this.getBindingUtil(i).onAfterChangeToShape?.({binding:i,shapeBefore:e,shapeAfter:t,reason:"self"});if(e.parentId!==t.parentId){let notifyBindingAncestryChange=e=>{let t=this.getShape(e);if(t)for(let e of this.getBindingsInvolvingShape(t))b.add(e.type),e.fromId===t.id&&this.getBindingUtil(e).onAfterChangeFromShape?.({binding:e,shapeBefore:t,shapeAfter:t,reason:"ancestry"}),e.toId===t.id&&this.getBindingUtil(e).onAfterChangeToShape?.({binding:e,shapeBefore:t,shapeAfter:t,reason:"ancestry"})};notifyBindingAncestryChange(t.id),this.visitDescendants(t.id,notifyBindingAncestryChange)}if(e.parentId!==t.parentId&&(0,eB.r5)(t.parentId)){let i=new Set([e.id]);for(let s of(this.visitDescendants(e.id,e=>{i.add(e)}),this.getPageStates())){if(s.pageId===t.parentId)continue;let e=cleanupInstancePageState(s,i);e&&this.store.put([e])}}e.parentId&&(0,eB.YT)(e.parentId)&&w.add(e.parentId),t.parentId!==e.parentId&&(0,eB.YT)(t.parentId)&&w.add(t.parentId)},beforeDelete:e=>{if(C.has(e.id))return;e.parentId&&(0,eB.YT)(e.parentId)&&w.add(e.parentId),C.add(e.id);let t=[];for(let i of this.getBindingsInvolvingShape(e)){b.add(i.type),t.push(i.id);let s=this.getBindingUtil(i);i.fromId===e.id?(s.onBeforeIsolateToShape?.({binding:i,removedShape:e}),s.onBeforeDeleteFromShape?.({binding:i,shape:e})):(s.onBeforeIsolateFromShape?.({binding:i,removedShape:e}),s.onBeforeDeleteToShape?.({binding:i,shape:e}))}t.length&&this.deleteBindings(t);let i=new Set([e.id]),s=(0,eF.oA)(this.getPageStates().map(e=>cleanupInstancePageState(e,i)));s.length&&this.store.put(s)}},binding:{beforeCreate:e=>{let t=this.getBindingUtil(e).onBeforeCreate?.({binding:e});return t||e},afterCreate:e=>{b.add(e.type),this.getBindingUtil(e).onAfterCreate?.({binding:e})},beforeChange:(e,t)=>{let i=this.getBindingUtil(t).onBeforeChange?.({bindingBefore:e,bindingAfter:t});return i||t},afterChange:(e,t)=>{b.add(t.type),this.getBindingUtil(t).onAfterChange?.({bindingBefore:e,bindingAfter:t})},beforeDelete:e=>{this.getBindingUtil(e).onBeforeDelete?.({binding:e})},afterDelete:e=>{this.getBindingUtil(e).onAfterDelete?.({binding:e}),b.add(e.type)}},page:{afterCreate:e=>{let t=eB.AN.createId(e.id),i=eB.iS.createId(e.id);this.store.has(t)||this.store.put([eB.AN.create({id:t})]),this.store.has(i)||this.store.put([eB.iS.create({id:i,pageId:e.id})])},afterDelete:(e,t)=>{if(this.getInstanceState()?.currentPageId===e.id){let i=this.getPages().find(t=>t.id!==e.id)?.id;i?this.store.put([{...this.getInstanceState(),currentPageId:i}]):"user"===t&&this.store.ensureStoreIsUsable()}let i=eB.AN.createId(e.id),s=eB.iS.createId(e.id);this.store.remove([i,s])}},instance:{afterChange:(e,t,i)=>{if(!this.store.has(t.currentPageId)){let s=this.store.has(e.currentPageId)?e.currentPageId:this.getPages()[0]?.id;s?this.store.update(t.id,e=>({...e,currentPageId:s})):"user"===i&&this.store.ensureStoreIsUsable()}}},instance_page_state:{afterChange:(e,t)=>{if(e?.selectedShapeIds!==t?.selectedShapeIds){let e=t.selectedShapeIds.filter(e=>{let i=this.getShape(e)?.parentId;for(;(0,eB.YT)(i);){if(t.selectedShapeIds.includes(i))return!1;i=this.getShape(i)?.parentId}return!0}),i=null;if(e.length>0){let t=this.findCommonAncestor((0,eF.oA)(e.map(e=>this.getShape(e))),e=>this.isShapeOfType(e,"group"));t&&(i=t)}else t?.focusedGroupId&&(i=t.focusedGroupId);(e.length!==t.selectedShapeIds.length||i!==t.focusedGroupId)&&this.store.put([{...t,selectedShapeIds:e,focusedGroupId:i??null}])}}}})),this._currentPageShapeIds=(0,e6.Q)(this.store,()=>this.getCurrentPageId()),this._parentIdsToChildIds=(0,e8.s)(this.store),this.disposables.add(this.store.listen(e=>{this.emit("change",e)})),this.disposables.add(this.history.dispose),this.run(()=>{this.store.ensureStoreIsUsable(),this._updateCurrentPageState({editingShapeId:null,hoveredShapeId:null,erasingShapeIds:[]})},{history:"ignore"}),o&&void 0===this.root.children[o])throw Error(`No state found for initialState "${o}".`);if(this.root.enter(void 0,"initial"),this.edgeScrollManager=new e7.O(this),this.focusManager=new e9.I(this,l),this.disposables.add(this.focusManager.dispose.bind(this.focusManager)),this.getInstanceState().followingUserId&&this.stopFollowingUser(),this.on("tick",this._flushEventsForTick),this.timers.requestAnimationFrame(()=>{this._tickManager.start()}),this.performanceTracker=new eF.aF,this.store.props.collaboration?.mode){let e=this.store.props.collaboration.mode;this.disposables.add((0,eb.Ym)("update collaboration mode",()=>{this.store.put([{...this.getInstanceState(),isReadonly:"readonly"===e.get()}])}))}}getIsShapeHiddenCache(){return this._getShapeVisibility?this.store.createComputedCache("isShapeHidden",e=>{let t=this._getShapeVisibility(e,this),i=!eB.ez.isId(e.parentId)&&this.isShapeHidden(e.parentId);return i?"visible"!==t:"hidden"===t}):null}isShapeHidden(e){return!!this._getShapeVisibility&&!!this.getIsShapeHiddenCache().get("string"==typeof e?e:e.id)}dispose(){this.disposables.forEach(e=>e()),this.disposables.clear(),this.store.dispose(),this.isDisposed=!0}getShapeUtil(e){let t="string"==typeof e?e:e.type,i=(0,eF.eg)(this.shapeUtils,t);return(0,eF.hu)(i,`No shape util found for type "${t}"`),i}hasShapeUtil(e){let t="string"==typeof e?e:e.type;return(0,eF.nr)(this.shapeUtils,t)}getBindingUtil(e){let t="string"==typeof e?e:e.type,i=(0,eF.eg)(this.bindingUtils,t);return(0,eF.hu)(i,`No binding util found for type "${t}"`),i}undo(){return this._flushEventsForTick(0),this.complete(),this.history.undo(),this}getCanUndo(){return this.history.getNumUndos()>0}redo(){return this._flushEventsForTick(0),this.complete(),this.history.redo(),this}clearHistory(){return this.history.clear(),this}getCanRedo(){return this.history.getNumRedos()>0}mark(e){return"string"==typeof e?console.warn(`[tldraw] \`editor.history.mark("${e}")\` is deprecated. Please use \`const myMarkId = editor.markHistoryStoppingPoint()\` instead.`):console.warn("[tldraw] `editor.mark()` is deprecated. Use `editor.markHistoryStoppingPoint()` instead."),this.history._mark(e??(0,eF.EL)()),this}markHistoryStoppingPoint(e){let t=`[${e??"stop"}]_${(0,eF.EL)()}`;return this.history._mark(t),t}getMarkIdMatching(e){return this.history.getMarkIdMatching(e)}squashToMark(e){return this.history.squashToMark(e),this}bail(){return this.history.bail(),this}bailToMark(e){return this.history.bailToMark(e),this}run(e,t){let i=this._shouldIgnoreShapeLock;this._shouldIgnoreShapeLock=t?.ignoreShapeLock??i;try{this.history.batch(e,t)}finally{this._shouldIgnoreShapeLock=i}return this}batch(e,t){return this.run(e,t)}annotateError(e,{origin:t,willCrashApp:i,tags:s,extras:r}){let n=this.createErrorAnnotations(t,i);return(0,eF.lw)(e,{tags:{...n.tags,...s},extras:{...n.extras,...r}}),i&&this.store.markAsPossiblyCorrupted(),this}createErrorAnnotations(e,t){try{let i=this.getEditingShapeId();return{tags:{origin:e,willCrashApp:t},extras:{activeStateNode:this.root.getPath(),selectedShapes:this.getSelectedShapes().map(e=>{let{props:t,...i}=e,{text:s,richText:r,...n}=t;return{...i,props:n}}),selectionCount:this.getSelectedShapes().length,editingShape:i?this.getShape(i):void 0,inputs:this.inputs,pageState:this.getCurrentPageState(),instanceState:this.getInstanceState(),collaboratorCount:this.getCollaboratorsOnCurrentPage().length}}}catch{return{tags:{origin:e,willCrashApp:t},extras:{}}}}getCrashingError(){return this._crashingError}crash(e){return this._crashingError=e,this.store.markAsPossiblyCorrupted(),this.emit("crash",{error:e}),this}getPath(){return this.root.getPath().split("root.")[1]}isIn(e){let t=e.split(".").reverse(),i=this.root;for(;t.length>0;){let e=t.pop();if(!e)return!0;let s=i.getCurrent();if(s?.id===e){if(0===t.length)return!0;i=s;continue}break}return!1}isInAny(...e){return e.some(e=>this.isIn(e))}setCurrentTool(e,t={}){return this.root.transition(e,t),this}getCurrentTool(){return this.root.getCurrent()}getCurrentToolId(){let e=this.getCurrentTool();return e?e.getCurrentToolIdMask()??e.id:""}getStateDescendant(e){let t=e.split(".").reverse(),i=this.root;for(;t.length>0;){let e=t.pop();if(!e)break;let s=i.children?.[e];if(!s)return;i=s}return i}getDocumentSettings(){return this.store.get(eB.G4)}updateDocumentSettings(e){return this.run(()=>{this.store.put([{...this.getDocumentSettings(),...e}])},{history:"ignore"}),this}getInstanceState(){return this.store.get(eB.PQ)}updateInstanceState(e,t){return this._updateInstanceState(e,{history:"ignore",...t}),void 0!==e.isChangingStyle&&(clearTimeout(this._isChangingStyleTimeout),!0===e.isChangingStyle&&(this._isChangingStyleTimeout=this.timers.setTimeout(()=>{this._updateInstanceState({isChangingStyle:!1},{history:"ignore"})},1e3))),this}_updateInstanceState(e,t){this.run(()=>{this.store.put([{...this.getInstanceState(),...e}])},t)}getOpenMenus(){return this.menus.getOpenMenus()}addOpenMenu(e){return this.menus.addOpenMenu(e),this}deleteOpenMenu(e){return this.menus.deleteOpenMenu(e),this}clearOpenMenus(){return this.menus.clearOpenMenus(),this}getIsMenuOpen(){return this.menus.hasAnyOpenMenus()}setCursor(e){return this.updateInstanceState({cursor:{...this.getInstanceState().cursor,...e}}),this}getPageStates(){return this._getPageStatesQuery().get()}_getPageStatesQuery(){return this.store.query.records("instance_page_state")}getCurrentPageState(){return this.store.get(this._getCurrentPageStateId())}_getCurrentPageStateId(){return eB.iS.createId(this.getCurrentPageId())}updateCurrentPageState(e){return this._updateCurrentPageState(e),this}_updateCurrentPageState(e){this.store.update(e.id??this.getCurrentPageState().id,t=>({...t,...e}))}getSelectedShapeIds(){return this.getCurrentPageState().selectedShapeIds}getSelectedShapes(){return(0,eF.oA)(this.getSelectedShapeIds().map(e=>this.store.get(e)))}setSelectedShapes(e){return this.run(()=>{let t=e.map(e=>"string"==typeof e?e:e.id),{selectedShapeIds:i}=this.getCurrentPageState(),s=new Set(i);if(t.length===s.size&&t.every(e=>s.has(e)))return null;this.store.put([{...this.getCurrentPageState(),selectedShapeIds:t}])},{history:"record-preserveRedoStack"})}isAncestorSelected(e){let t="string"==typeof e?e:e?.id??null,i=this.getShape(t);if(!i)return!1;let s=this.getSelectedShapeIds();return!!this.findShapeAncestor(i,e=>s.includes(e.id))}select(...e){let t="string"==typeof e[0]?e:e.map(e=>e.id);return this.setSelectedShapes(t),this}deselect(...e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=this.getSelectedShapeIds();return i.length>0&&t.length>0&&this.setSelectedShapes(i.filter(e=>!t.includes(e))),this}selectAll(){let e=null,t=this.getSelectedShapeIds();if(t.length>0)for(let i of t){let t=this.getShape(i);if(t){if(null===e)e=t.parentId;else if(e!==t.parentId)return this}}e||(e=this.getCurrentPageId());let i=this.getSortedChildIdsForParent(e);return i.length<=0||this.setSelectedShapes(this._getUnlockedShapeIds(i)),this}selectAdjacentShape(e){let t;let i=this.getSelectedShapeIds(),s=i[0]?this.getShape(i[0])?.parentId:null,r=s&&i.every(e=>this.getShape(e)?.parentId===s)&&!(0,eB.r5)(s),n=r?this.getCurrentPageShapes().filter(e=>e.parentId===s):this.getCurrentPageShapes().filter(e=>(0,eB.r5)(e.parentId)),a=r?this._getShapesInReadingOrder(n):this.getCurrentPageShapesInReadingOrder(),h=1===i.length?i[0]:a.find(e=>i.includes(e.id))?.id;if("next"===e||"prev"===e){let i=a.map(e=>e.id),s=h?i.indexOf(h):-1,r=(s+("next"===e?1:-1)+i.length)%i.length;t=i[r]}else{if(!h)return;t=this.getNearestAdjacentShape(n,h,e)}let o=this.getShape(t);o&&this._selectShapesAndZoom([o.id])}getCurrentPageShapesInReadingOrder(){let e=this.getCurrentPageShapes().filter(e=>(0,eB.r5)(e.parentId));return this._getShapesInReadingOrder(e)}_getShapesInReadingOrder(e){let t=e.filter(e=>this.getShapeUtil(e).canTabTo(e));if(t.length<=1)return t;let i=t.map(e=>({shape:e,center:this.getShapePageBounds(e).center}));i.sort((e,t)=>e.center.y-t.center.y);let s=[];for(let e of i){let t=-1;for(let i=s.length-1;i>=0;i--){let r=s[i],n=r[r.length-1];if(100>Math.abs(e.center.y-n.center.y)){t=i;break}}-1===t?s.push([e]):s[t].push(e)}for(let e of s)e.sort((e,t)=>e.center.x-t.center.x);for(let e of s)if(!(e.length<=2))for(let t=0;t<e.length-2;t++){let i=e[t],s=e[t+1],r=e[t+2],n=eH.B.Dist2(i.center,s.center),a=eH.B.Dist2(i.center,r.center);if(a<.9*n){let s=Math.abs(eH.B.Angle(i.center,r.center)*(180/Math.PI));s<=20&&([e[t+1],e[t+2]]=[e[t+2],e[t+1]])}}return s.flat().map(e=>e.shape)}getNearestAdjacentShape(e,t,i){let s={right:0,left:180,down:90,up:270},r=this.getShape(t);if(!r)return t;let n=e.filter(e=>this.getShapeUtil(e).canTabTo(e)&&e.id!==t);if(!n.length)return t;let a=this.getShapePageBounds(r).center,h=n.map(e=>({shape:e,center:this.getShapePageBounds(e).center})),o=h.filter(({center:e})=>{let t=e.x>a.x,s=e.y>a.y,r=e.x-a.x,n=e.y-a.y;return"left"===i||"right"===i?Math.abs(n)<2*Math.abs(r)&&("right"===i?t:!t):"up"===i||"down"===i?Math.abs(r)<2*Math.abs(n)&&("down"===i?s:!s):void 0});if(0===o.length)return t;let l=(0,eF.F)(o,({center:e})=>{let t=eH.B.Dist2(a,e),r=["left","right"].includes(i)?"x":"y",n=Math.abs(e[r]-a[r]),h=["left","right"].includes(i)?"y":"x",o=Math.abs(e[h]-a[h]),l=Math.abs(eH.B.Angle(a,e)*(180/Math.PI)),d=Math.abs(l-s[i]);return 1*t+2*o+(t-n)*1.5+.5*d});return l.shape.id}selectParentShape(){let e=this.getOnlySelectedShape();if(!e)return;let t=this.getShape(e.parentId);t&&this._selectShapesAndZoom([t.id])}selectFirstChildShape(){let e=this.getSelectedShapes();if(!e.length)return;let t=e[0],i=this.getSortedChildIdsForParent(t.id).map(e=>this.getShape(e)).filter(e=>e),s=this._getShapesInReadingOrder(i);0!==s.length&&this._selectShapesAndZoom([s[0].id])}_selectShapesAndZoom(e){this.setSelectedShapes(e),this.zoomToSelectionIfOffscreen(256,{animation:{duration:this.options.animationMediumMs},inset:0})}selectNone(){return this.getSelectedShapeIds().length>0&&this.setSelectedShapes([]),this}getOnlySelectedShapeId(){return this.getOnlySelectedShape()?.id??null}getOnlySelectedShape(){let e=this.getSelectedShapes();return 1===e.length?e[0]:null}getShapesPageBounds(e){let t=(0,eF.oA)(e.map(e=>this.getShapePageBounds(e)));return 0===t.length?null:eD.xu.Common(t)}getSelectionPageBounds(){return this.getShapesPageBounds(this.getSelectedShapeIds())}getSelectionScreenBounds(){let e=this.getSelectionPageBounds();if(!e)return;let{x:t,y:i}=this.pageToScreen(e.point),s=this.getZoomLevel();return new eD.xu(t,i,e.width*s,e.height*s)}getShapesSharedRotation(e){let t=!1,i=0;for(let s=0,r=e.length;s<r;s++){let r=this.getShapePageTransform(e[s]);if(r){if(t){if(r.rotation()!==i)return 0}else t=!0,i=r.rotation()}}return i}getSelectionRotation(){return this.getShapesSharedRotation(this.getSelectedShapeIds())}getShapesRotatedPageBounds(e){if(0===e.length)return;let t=this.getShapesSharedRotation(e);if(0===t)return this.getShapesPageBounds(e)??void 0;if(1===e.length){let t=this.getShapeGeometry(e[0]).bounds.clone(),i=this.getShapePageTransform(e[0]);return t.point=i.applyToPoint(t.point),t}let i=eD.xu.FromPoints(e.flatMap(e=>{let t=this.getShapePageTransform(e);return t?t.applyToPoints(this.getShapeGeometry(e).bounds.corners):[]}).map(e=>e.rot(-t)));return i.point=i.point.rot(t),i}getSelectionRotatedPageBounds(){return this.getShapesRotatedPageBounds(this.getSelectedShapeIds())}getSelectionRotatedScreenBounds(){let e=this.getSelectionRotatedPageBounds();if(!e)return;let{x:t,y:i}=this.pageToScreen(e.point),s=this.getZoomLevel();return new eD.xu(t,i,e.width*s,e.height*s)}getFocusedGroupId(){return this.getCurrentPageState().focusedGroupId??this.getCurrentPageId()}getFocusedGroup(){let e=this.getFocusedGroupId();return e?this.getShape(e):void 0}setFocusedGroup(e){let t="string"==typeof e?e:e?.id??null;if(null!==t){let e=this.getShape(t);if(!e)throw Error(`Editor.setFocusedGroup: Shape with id ${t} does not exist`);if(!this.isShapeOfType(e,"group"))throw Error(`Editor.setFocusedGroup: Cannot set focused group to shape of type ${e.type}`)}return t===this.getFocusedGroupId()?this:this.run(()=>{this.store.update(this.getCurrentPageState().id,e=>({...e,focusedGroupId:t}))},{history:"record-preserveRedoStack"})}popFocusedGroupId(){let e=this.getFocusedGroup();if(e){let t=this.findShapeAncestor(e,e=>this.isShapeOfType(e,"group"));this.setFocusedGroup(t?.id??null),this.select(e.id)}else this.setFocusedGroup(null),this.selectNone();return this}getEditingShapeId(){return this.getCurrentPageState().editingShapeId}getEditingShape(){let e=this.getEditingShapeId();return e?this.getShape(e):void 0}setEditingShape(e){let t="string"==typeof e?e:e?.id??null;this.setRichTextEditor(null);let i=this.getEditingShapeId();if(t!==i){if(t){let e=this.getShape(t);if(e&&this.getShapeUtil(e).canEdit(e))return this.run(()=>{if(this._updateCurrentPageState({editingShapeId:t}),i){let e=this.getShape(i);e&&this.getShapeUtil(e).onEditEnd?.(e)}this.getShapeUtil(e).onEditStart?.(e)},{history:"ignore"}),this}this.run(()=>{if(this._updateCurrentPageState({editingShapeId:null}),this._currentRichTextEditor.set(null),i){let e=this.getShape(i);e&&this.getShapeUtil(e).onEditEnd?.(e)}},{history:"ignore"})}return this}getRichTextEditor(){return this._currentRichTextEditor.get()}setRichTextEditor(e){return this._currentRichTextEditor.set(e),this}getHoveredShapeId(){return this.getCurrentPageState().hoveredShapeId}getHoveredShape(){let e=this.getHoveredShapeId();return e?this.getShape(e):void 0}setHoveredShape(e){let t="string"==typeof e?e:e?.id??null;return t===this.getHoveredShapeId()||this.run(()=>{this.updateCurrentPageState({hoveredShapeId:t})},{history:"ignore"}),this}getHintingShapeIds(){return this.getCurrentPageState().hintingShapeIds}getHintingShape(){let e=this.getHintingShapeIds();return(0,eF.oA)(e.map(e=>this.getShape(e)))}setHintingShapes(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);return this.run(()=>{this._updateCurrentPageState({hintingShapeIds:(0,eF.D8)(t)})},{history:"ignore"}),this}getErasingShapeIds(){return this.getCurrentPageState().erasingShapeIds}getErasingShapes(){let e=this.getErasingShapeIds();return(0,eF.oA)(e.map(e=>this.getShape(e)))}setErasingShapes(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);t.sort();let i=this.getErasingShapeIds();return this.run(()=>{if(t.length===i.length){for(let e=0;e<t.length;e++)if(t[e]!==i[e]){this._updateCurrentPageState({erasingShapeIds:t});break}}else this._updateCurrentPageState({erasingShapeIds:t})},{history:"ignore"}),this}getCroppingShapeId(){return this.getCurrentPageState().croppingShapeId}setCroppingShape(e){let t="string"==typeof e?e:e?.id??null;return t!==this.getCroppingShapeId()&&this.run(()=>{if(t){let e=this.getShape(t),i=this.getShapeUtil(e);e&&i.canCrop(e)&&this.updateCurrentPageState({croppingShapeId:t})}else this.updateCurrentPageState({croppingShapeId:null})},{history:"ignore"}),this}getTextOptions(){return(0,eF.kP)(this._textOptions.get(),"Cannot use text without setting textOptions")}_unsafe_getCameraId(){return eB.AN.createId(this.getCurrentPageId())}getCamera(){let e=this.store.get(this._unsafe_getCameraId());if(this._isLockedOnFollowingUser.get()){let t=this.getCameraForFollowing();if(t)return{...e,...t}}return e}_getFollowingPresence(e){let t=[this.user.getId()],i=this.getCollaborators(),s=null;for(;e&&!t.includes(e);)s=i.find(t=>t.userId===e)??null,e=s?.followingUserId??null,s&&t.push(s.userId);return s}getViewportPageBoundsForFollowing(){let e=this._getFollowingPresence(this.getInstanceState().followingUserId);if(!e?.camera||!e?.screenBounds)return null;let{w:t,h:i}=e.screenBounds,{x:s,y:r,z:n}=e.camera,a=new eD.xu(-s,-r,t/n,i/n),h=this.getViewportScreenBounds().clone(),o=h.width/h.height;return h.width=a.width,h.height=h.width/o,h.height<a.height&&(h.height=a.height,h.width=h.height*o),h.center=a.center,h}getCameraForFollowing(){let e=this.getViewportPageBoundsForFollowing();return e?{x:-e.x,y:-e.y,z:this.getViewportScreenBounds().w/e.width}:null}getZoomLevel(){return this.getCamera().z}getInitialZoom(){let e=this.getCameraOptions();if(!e.constraints||"default"===e.constraints.initialZoom)return 1;let{zx:t,zy:i}=getCameraFitXFitY(this,e);switch(e.constraints.initialZoom){case"fit-min":return Math.max(t,i);case"fit-max":return Math.min(t,i);case"fit-x":return t;case"fit-y":return i;case"fit-min-100":return Math.min(1,Math.max(t,i));case"fit-max-100":return Math.min(1,Math.min(t,i));case"fit-x-100":return Math.min(1,t);case"fit-y-100":return Math.min(1,i);default:throw(0,eF.iP)(e.constraints.initialZoom)}}getBaseZoom(){let e=this.getCameraOptions();if(!e.constraints||"default"===e.constraints.baseZoom)return 1;let{zx:t,zy:i}=getCameraFitXFitY(this,e);switch(e.constraints.baseZoom){case"fit-min":return Math.max(t,i);case"fit-max":return Math.min(t,i);case"fit-x":return t;case"fit-y":return i;case"fit-min-100":return Math.min(1,Math.max(t,i));case"fit-max-100":return Math.min(1,Math.min(t,i));case"fit-x-100":return Math.min(1,t);case"fit-y-100":return Math.min(1,i);default:throw(0,eF.iP)(e.constraints.baseZoom)}}getCameraOptions(){return this._cameraOptions.get()}setCameraOptions(e){let t=(0,eF.v4)({...this._cameraOptions.__unsafe__getWithoutCapture(),...e});return t.zoomSteps?.length<1&&(t.zoomSteps=[1]),this._cameraOptions.set(t),this.setCamera(this.getCamera()),this}getConstrainedCamera(e,t){let i=this.getCamera(),{x:s,y:r,z:n=i.z}=e;if(!t?.force){let e=this.getCameraOptions(),a=e.zoomSteps[0],h=(0,eF.Z$)(e.zoomSteps),o=this.getViewportScreenBounds();if(e.constraints){let{constraints:l}=e,d=Math.min(l.padding.y,o.w/2),p=Math.min(l.padding.x,o.h/2),g=eD.xu.From(e.constraints.bounds),u=(o.w-2*p)/g.w,c=(o.h-2*d)/g.h,S=this.getBaseZoom(),f=h*S,m=a*S;if(t?.reset&&(n=this.getInitialZoom()),n<m||n>f){let{x:e,y:t,z:a}=i,h=-e+o.w/a/2,l=-t+o.h/a/2;n=(0,eX.uZ)(n,m,f);let d=-e+o.w/n/2,p=-t+o.h/n/2;s=e+d-h,r=t+p-l}let y=p/n-g.x,_=d/n-g.y,P=(o.w-2*p)/n-g.w,I=(o.h-2*d)/n-g.h,C=y+P*l.origin.x,w=_+I*l.origin.y,b="string"==typeof l.behavior?l.behavior:l.behavior.x,T="string"==typeof l.behavior?l.behavior:l.behavior.y;if(t?.reset)s=C,r=w;else{switch(b){case"fixed":s=C;break;case"contain":s=n<u?C:(0,eX.uZ)(s,y+P,y);break;case"inside":s=n<u?(0,eX.uZ)(s,y,(o.w-p)/n-g.w):(0,eX.uZ)(s,y+P,y);break;case"outside":s=(0,eX.uZ)(s,p/n-g.w,(o.w-p)/n);break;case"free":break;default:throw(0,eF.iP)(b)}switch(T){case"fixed":r=w;break;case"contain":r=n<c?w:(0,eX.uZ)(r,_+I,_);break;case"inside":r=n<c?(0,eX.uZ)(r,_,(o.h-d)/n-g.h):(0,eX.uZ)(r,_+I,_);break;case"outside":r=(0,eX.uZ)(r,d/n-g.h,(o.h-d)/n);break;case"free":break;default:throw(0,eF.iP)(T)}}}else if(n>h||n<a){let{x:e,y:t,z:l}=i;n=(0,eX.uZ)(n,a,h),s=e+(-e+o.w/n/2)-(-e+o.w/l/2),r=t+(-t+o.h/n/2)-(-t+o.h/l/2)}}return{x:s,y:r,z:n}}_setCamera(e,t){let i=this.getCamera(),{x:s,y:r,z:n}=this.getConstrainedCamera(e,t);return i.x===s&&i.y===r&&i.z===n||(0,eb.ay)(()=>{let e={...i,x:s,y:r,z:n};this.run(()=>{this.store.put([e])},{history:"ignore"});let{currentScreenPoint:a,currentPagePoint:h}=this.inputs,{screenBounds:o}=this.store.unsafeGetWithoutCapture(eB.PQ);if(a.x/n-s!==h.x||a.y/n-r!==h.y){let e={type:"pointer",target:"canvas",name:"pointer_move",point:eH.B.AddXY(a,o.x,o.y),pointerId:eO.CK.CAMERA_MOVE,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,shiftKey:this.inputs.shiftKey,metaKey:this.inputs.metaKey,accelKey:(0,e0.q)(this.inputs),button:0,isPen:this.getInstanceState().isPenMode??!1};t?.immediate?this._flushEventForTick(e):this.dispatch(e)}this._tickCameraState()}),this}setCamera(e,t){let{isLocked:i}=this._cameraOptions.__unsafe__getWithoutCapture();if(i&&!t?.force)return this;this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser();let s=eH.B.Cast(e);Number.isFinite(s.x)||(s.x=0),Number.isFinite(s.y)||(s.y=0),void 0!==s.z&&Number.isFinite(s.z)||(e.z=this.getZoomLevel());let r=this.getConstrainedCamera(s,t);if(t?.animation){let{width:e,height:i}=this.getViewportScreenBounds();this._animateToViewport(new eD.xu(-r.x,-r.y,e/r.z,i/r.z),t)}else this._setCamera(r,{...t,force:!0});return this}centerOnPoint(e,t){let{isLocked:i}=this.getCameraOptions();if(i&&!t?.force)return this;let{width:s,height:r}=this.getViewportPageBounds();return this.setCamera(new eH.B(-(e.x-s/2),-(e.y-r/2),this.getCamera().z),t),this}zoomToFit(e){let t=[...this.getCurrentPageShapeIds()];if(t.length<=0)return this;let i=eD.xu.Common((0,eF.oA)(t.map(e=>this.getShapePageBounds(e))));return this.zoomToBounds(i,e),this}resetZoom(e=this.getViewportScreenCenter(),t){let{isLocked:i,constraints:s}=this.getCameraOptions();if(i&&!t?.force)return this;let r=this.getCamera(),{x:n,y:a,z:h}=r,{x:o,y:l}=e,d=1;if(s){let e=this.getInitialZoom();h!==e&&(d=e)}return this.setCamera(new eH.B(n+(o/d-o)-(o/h-o),a+(l/d-l)-(l/h-l),d),t),this}zoomIn(e=this.getViewportScreenCenter(),t){let{isLocked:i}=this.getCameraOptions();if(i&&!t?.force)return this;let{x:s,y:r,z:n}=this.getCamera(),{zoomSteps:a}=this.getCameraOptions();if(null!==a&&a.length>1){let i=this.getBaseZoom(),h=(0,eF.Z$)(a)*i;for(let e=1;e<a.length;e++){let t=a[e-1]*i,s=a[e]*i;if(!(s-n<=(s-t)/2)){h=s;break}}this.setCamera(new eH.B(s+(e.x/h-e.x)-(e.x/n-e.x),r+(e.y/h-e.y)-(e.y/n-e.y),h),t)}return this}zoomOut(e=this.getViewportScreenCenter(),t){let{isLocked:i}=this.getCameraOptions();if(i&&!t?.force)return this;let{zoomSteps:s}=this.getCameraOptions();if(null!==s&&s.length>1){let i=this.getBaseZoom(),{x:r,y:n,z:a}=this.getCamera(),h=s[0]*i;for(let e=s.length-1;e>0;e--){let t=s[e-1]*i,r=s[e]*i;if(!(r-a>=(r-t)/2)){h=t;break}}this.setCamera(new eH.B(r+(e.x/h-e.x)-(e.x/a-e.x),n+(e.y/h-e.y)-(e.y/a-e.y),h),t)}return this}zoomToSelection(e){let{isLocked:t}=this.getCameraOptions();if(t&&!e?.force)return this;let i=this.getSelectionPageBounds();return i&&this.zoomToBounds(i,{targetZoom:Math.max(1,this.getZoomLevel()),...e}),this}zoomToSelectionIfOffscreen(e=16,t){let i=this.getSelectionPageBounds(),s=this.getViewportPageBounds();if(i&&!s.contains(i)){let r=i.clone().expandBy(e/this.getZoomLevel()).expand(s),n=s.clone().translate({x:(r.center.x-s.center.x)*2,y:(r.center.y-s.center.y)*2});this.zoomToBounds(n,t)}}zoomToBounds(e,t){let i=this._cameraOptions.__unsafe__getWithoutCapture();if(i.isLocked&&!t?.force)return this;let s=this.getViewportScreenBounds(),r=t?.inset??Math.min(eO.TP,.28*s.width),n=this.getBaseZoom(),a=i.zoomSteps[0],h=(0,eF.Z$)(i.zoomSteps),o=(0,eX.uZ)(Math.min((s.width-r)/e.w,(s.height-r)/e.h),a*n,h*n);return t?.targetZoom!==void 0&&(o=Math.min(t.targetZoom,o)),this.setCamera(new eH.B(-e.x+(s.width-e.w*o)/2/o,-e.y+(s.height-e.h*o)/2/o,o),t),this}stopCameraAnimation(){return this.emit("stop-camera-animation"),this}_animateViewport(e){if(!this._viewportAnimation)return;this._viewportAnimation.elapsed+=e;let{elapsed:t,easing:i,duration:s,start:r,end:n}=this._viewportAnimation;if(t>s){this.off("tick",this._animateViewport),this._viewportAnimation=null,this._setCamera(new eH.B(-n.x,-n.y,this.getViewportScreenBounds().width/n.width));return}let a=s-t,h=i(1-a/s),o=r.minX+(n.minX-r.minX)*h,l=r.minY+(n.minY-r.minY)*h,d=r.maxX+(n.maxX-r.maxX)*h;this._setCamera(new eH.B(-o,-l,this.getViewportScreenBounds().width/(d-o)),{force:!0})}_animateToViewport(e,t={animation:eO.Xy}){let{animation:i,...s}=t;if(!i)return;let{duration:r=0,easing:n=eZ.L.easeInOutCubic}=i,a=this.user.getAnimationSpeed(),h=this.getViewportPageBounds();return(this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser(),0===r||0===a)?this._setCamera(new eH.B(-e.x,-e.y,this.getViewportScreenBounds().width/e.width),{...s}):(this._viewportAnimation={elapsed:0,duration:r/a,easing:n,start:h.clone(),end:e.clone()},this.once("stop-camera-animation",()=>{this.off("tick",this._animateViewport),this._viewportAnimation=null}),this.on("tick",this._animateViewport),this)}slideCamera(e={}){let{isLocked:t}=this.getCameraOptions();if(t&&!e?.force)return this;let i=this.user.getAnimationSpeed();if(0===i)return this;this.stopCameraAnimation();let{speed:s,friction:r=this.options.cameraSlideFriction,direction:n,speedThreshold:a=.01}=e,h=Math.min(s,1),cancel=()=>{this.off("tick",moveCamera),this.off("stop-camera-animation",cancel)};this.once("stop-camera-animation",cancel);let moveCamera=e=>{let{x:t,y:i,z:s}=this.getCamera(),o=eH.B.Mul(n,h*e/s);(h*=1-r)<a?cancel():this._setCamera(new eH.B(t+o.x,i+o.y,s))};return this.on("tick",moveCamera),this}zoomToUser(e,t={animation:{duration:500}}){let i=this.getCollaborators().find(t=>t.userId===e);if(!i)return this;let s=i.cursor;return s&&this.run(()=>{null!==this.getInstanceState().followingUserId&&this.stopFollowingUser();let r=i.currentPageId===this.getCurrentPageId();r||this.setCurrentPage(i.currentPageId),t&&t.animation&&!r&&(t.animation=void 0),this.centerOnPoint(s,t);let{highlightedUserIds:n}=this.getInstanceState();this.updateInstanceState({highlightedUserIds:[...n,e]}),this.timers.setTimeout(()=>{let t=[...this.getInstanceState().highlightedUserIds],i=t.indexOf(e);i<0||(t.splice(i,1),this.updateInstanceState({highlightedUserIds:t}))},this.options.collaboratorIdleTimeoutMs)}),this}updateViewportScreenBounds(e,t=!1){if(e instanceof eD.xu)e.width=Math.max(e.width,1),e.height=Math.max(e.height,1);else{let t=e.getBoundingClientRect();e=new eD.xu(t.left||t.x,t.top||t.y,Math.max(t.width,1),Math.max(t.height,1))}let i=[0!==e.minY,!(0,eX.C2)(document.body.scrollWidth,e.maxX,1),!(0,eX.C2)(document.body.scrollHeight,e.maxY,1),0!==e.minX],{_willSetInitialBounds:s}=this;this._willSetInitialBounds=!1;let{screenBounds:r,insets:n}=this.getInstanceState();if(e.equals(r)&&i.every((e,t)=>e===n[t]))return this;if(s)this.updateInstanceState({screenBounds:e.toJson(),insets:i}),this.setCamera(this.getCamera());else if(t&&!this.getInstanceState().followingUserId){let t=this.getViewportPageBounds().center;this.updateInstanceState({screenBounds:e.toJson(),insets:i}),this.centerOnPoint(t)}else this.updateInstanceState({screenBounds:e.toJson(),insets:i}),this._setCamera(eH.B.From({...this.getCamera()}));return this._tickCameraState(),this}getViewportScreenBounds(){let{x:e,y:t,w:i,h:s}=this.getInstanceState().screenBounds;return new eD.xu(e,t,i,s)}getViewportScreenCenter(){let e=this.getViewportScreenBounds();return new eH.B(e.w/2,e.h/2)}getViewportPageBounds(){let{w:e,h:t}=this.getViewportScreenBounds(),{x:i,y:s,z:r}=this.getCamera();return new eD.xu(-i,-s,e/r,t/r)}screenToPage(e){let{screenBounds:t}=this.store.unsafeGetWithoutCapture(eB.PQ),{x:i,y:s,z:r=1}=this.getCamera();return new eH.B((e.x-t.x)/r-i,(e.y-t.y)/r-s,e.z??.5)}pageToScreen(e){let{screenBounds:t}=this.store.unsafeGetWithoutCapture(eB.PQ),{x:i,y:s,z:r=1}=this.getCamera();return new eH.B((e.x+i)*r+t.x,(e.y+s)*r+t.y,e.z??.5)}pageToViewport(e){let{x:t,y:i,z:s=1}=this.getCamera();return new eH.B((e.x+t)*s,(e.y+i)*s,e.z??.5)}_getCollaboratorsQuery(){return this.store.query.records("instance_presence",()=>({userId:{neq:this.user.getId()}}))}getCollaborators(){let e=this._getCollaboratorsQuery().get();if(!e.length)return eb.LZ;let t=[...new Set(e.map(e=>e.userId))].sort();return t.map(t=>{let i=(0,eF.UT)(e.filter(e=>e.userId===t),e=>e.lastActivityTimestamp??0);return i})}getCollaboratorsOnCurrentPage(){let e=this.getCurrentPageId();return this.getCollaborators().filter(t=>t.currentPageId===e)}startFollowingUser(e){this.stopFollowingUser();let t=this.user.getId();t||console.warn("You should set the userId for the current instance before following a user");let i=this._getFollowingPresence(e);if(!i)return this;let s=(0,eb.Fl)("latestLeaderPresence",()=>this._getFollowingPresence(e));return(0,eb.ay)(()=>{this.updateInstanceState({followingUserId:e},{history:"ignore"});let t=(0,eb.Ym)("update current page",()=>{let e=s.get();if(!e){this.stopFollowingUser();return}e.currentPageId!==this.getCurrentPageId()&&this.getPage(e.currentPageId)&&this.run(()=>{this.store.put([{...this.getInstanceState(),currentPageId:e.currentPageId}]),this._isLockedOnFollowingUser.set(!0)},{history:"ignore"})}),cancel=()=>{t(),this._isLockedOnFollowingUser.set(!1),this.off("frame",moveTowardsUser),this.off("stop-following",cancel)},moveTowardsUser=()=>{let e=s.get();if(!e){this.stopFollowingUser();return}if(this._isLockedOnFollowingUser.get())return;let t=this.user.getAnimationSpeed();if(0===t){this._isLockedOnFollowingUser.set(!0);return}let i=this.getViewportPageBoundsForFollowing();if(!i){this.stopFollowingUser();return}let r=this.getViewportPageBounds(),n=Math.abs(i.minX-r.minX)+Math.abs(i.maxX-r.maxX),a=Math.abs(i.minY-r.minY)+Math.abs(i.maxY-r.maxY);if(n<this.options.followChaseViewportSnap&&a<this.options.followChaseViewportSnap){this._isLockedOnFollowingUser.set(!0);return}let h=(0,eX.uZ)(.5*t,.1,.8),o=new eD.xu((0,eF.t7)(r.minX,i.minX,h),(0,eF.t7)(r.minY,i.minY,h),(0,eF.t7)(r.width,i.width,h),(0,eF.t7)(r.height,i.height,h)),l=new eH.B(-o.x,-o.y,this.getViewportScreenBounds().width/o.width);this.stopCameraAnimation(),this._setCamera(l)};this.once("stop-following",cancel),this.addListener("frame",moveTowardsUser),moveTowardsUser()}),this}stopFollowingUser(){return this.run(()=>{this.store.put([this.getCamera()]),this._isLockedOnFollowingUser.set(!1),this.updateInstanceState({followingUserId:null}),this.emit("stop-following")},{history:"ignore"}),this}getUnorderedRenderingShapes(e){let t=[],i=2*this.options.maxShapesPerPage,s=this.options.maxShapesPerPage,r=this.getErasingShapeIds(),addShapeById=(n,a,h)=>{let o=this.getShape(n);if(!o)return;if(this.isShapeHidden(o)){let e=h||r.includes(n);for(let t of this.getSortedChildIdsForParent(n))addShapeById(t,a,e);return}a*=o.opacity;let l=!1,d=this.getShapeUtil(o);e&&(l=!h&&r.includes(n))&&(a*=.32),t.push({id:n,shape:o,util:d,index:i,backgroundIndex:s,opacity:a}),i+=1,s+=1;let p=this.getSortedChildIdsForParent(n);if(!p.length)return;let g=null;for(let e of(d.providesBackgroundForChildren(o)&&(g=s,s=i,i+=this.options.maxShapesPerPage),p))addShapeById(e,a,h||l);null!==g&&(s=g)},n=e?[this.getCurrentPage()]:this.getPages();for(let e of n)for(let t of this.getSortedChildIdsForParent(e.id))addShapeById(t,1,!1);return t}_decayCameraStateTimeout(e){this._cameraStateTimeoutRemaining-=e,this._cameraStateTimeoutRemaining>0||(this.off("tick",this._decayCameraStateTimeout),this._cameraState.set("idle"))}_tickCameraState(){this._cameraStateTimeoutRemaining=this.options.cameraMovingTimeoutMs,"idle"===this._cameraState.__unsafe__getWithoutCapture()&&(this._cameraState.set("moving"),this.on("tick",this._decayCameraStateTimeout))}getCameraState(){return this._cameraState.get()}getRenderingShapes(){let e=this.getUnorderedRenderingShapes(!0);return e.sort(eF.uv)}_getAllPagesQuery(){return this.store.query.records("page")}getPages(){return Array.from(this._getAllPagesQuery().get()).sort(eF.hl)}getCurrentPage(){return this.getPage(this.getCurrentPageId())}getCurrentPageId(){return this.getInstanceState().currentPageId}getPage(e){return this.store.get("string"==typeof e?e:e.id)}getCurrentPageShapeIds(){return this._currentPageShapeIds.get()}getCurrentPageShapeIdsSorted(){return Array.from(this.getCurrentPageShapeIds()).sort()}getPageShapeIds(e){let t="string"==typeof e?e:e.id,i=this.store.query.exec("shape",{parentId:{eq:t}});return this.getShapeAndDescendantIds(i.map(e=>e.id))}setCurrentPage(e){let t="string"==typeof e?e:e.id;return this.store.has(t)?(this.stopFollowingUser(),this.complete(),this.run(()=>{this.store.put([{...this.getInstanceState(),currentPageId:t}]),this.setCamera(this.getCamera())},{history:"record-preserveRedoStack"})):(console.error("Tried to set the current page id to a page that doesn't exist."),this)}updatePage(e){if(this.getIsReadonly())return this;let t=this.getPage(e.id);return t?this.run(()=>this.store.update(e.id,t=>({...t,...e}))):this}createPage(e){return this.run(()=>{if(this.getIsReadonly()||this.getPages().length>=this.options.maxPages)return;let t=this.getPages(),i=(0,eJ.u)(e.name??"Page 1",t.map(e=>e.name)),s=e.index;(!s||t.some(e=>e.index===s))&&(s=(0,eF._L)(t[t.length-1].index));let r=eB.ez.create({meta:{},...e,name:i,index:s});this.store.put([r])}),this}deletePage(e){let t="string"==typeof e?e:e.id;return this.run(()=>{if(this.getIsReadonly())return;let e=this.getPages();if(1===e.length)return;let i=this.getPage(t);if(i){if(t===this.getCurrentPageId()){let i=e.findIndex(e=>e.id===t),s=e[i-1]??e[i+1];this.setCurrentPage(s.id)}this.store.remove([i.id])}}),this}duplicatePage(e,t=eB.ez.createId()){if(this.getPages().length>=this.options.maxPages)return this;let i="string"==typeof e?e:e.id,s=this.getPage(i);if(!s)return this;let r={...this.getCamera()},n=this.getContentFromCurrentPage(this.getSortedChildIdsForParent(s.id));return this.run(()=>{let e=this.getPages(),i=(0,eF.eI)(s.index,e[e.indexOf(s)+1]?.index);if(this.createPage({name:s.name+" Copy",id:t,index:i}),this.setCurrentPage(t),this.setCamera(r),n)return this.putContentOntoCurrentPage(n)}),this}renamePage(e,t){let i="string"==typeof e?e:e.id;return this.getIsReadonly()||this.updatePage({id:i,name:t}),this}_getAllAssetsQuery(){return this.store.query.records("asset")}getAssets(){return this._getAllAssetsQuery().get()}createAssets(e){return this.getIsReadonly()||e.length<=0||this.run(()=>this.store.put(e),{history:"ignore"}),this}updateAssets(e){return this.getIsReadonly()||e.length<=0||this.run(()=>{this.store.put(e.map(e=>({...this.store.get(e.id),...e})))},{history:"ignore"}),this}deleteAssets(e){if(this.getIsReadonly())return this;let t="string"==typeof e[0]?e:e.map(e=>e.id);return t.length<=0||this.run(()=>{this.store.props.assets.remove?.(t),this.store.remove(t)},{history:"ignore"}),this}getAsset(e){return this.store.get("string"==typeof e?e:e.id)}async resolveAssetUrl(e,t){if(!e)return null;let i=this.getAsset(e);if(!i)return null;let{screenScale:s=1,shouldResolveToOriginal:r=!1,dpr:n=this.getInstanceState().devicePixelRatio}=t,a=Math.pow(2,Math.ceil(Math.log2(s))),h="connection"in navigator?navigator.connection.effectiveType:null;return await this.store.props.assets.resolve(i,{screenScale:s||1,steppedScreenScale:a,dpr:n,networkEffectiveType:h,shouldResolveToOriginal:r})}async uploadAsset(e,t,i){return await this.store.props.assets.upload(e,t,i)}getShapeGeometry(e,t){let i=t?.context??"none";return this._shapeGeometryCaches[i]||(this._shapeGeometryCaches[i]=this.store.createComputedCache("bounds",e=>(this.fonts.trackFontsForShape(e),this.getShapeUtil(e).getGeometry(e,t)),{areRecordsEqual:eq.e})),this._shapeGeometryCaches[i].get("string"==typeof e?e:e.id)}_getShapeHandlesCache(){return this.store.createComputedCache("handles",e=>this.getShapeUtil(e).getHandles?.(e),{areRecordsEqual:eq.e})}getShapeHandles(e){return this._getShapeHandlesCache().get("string"==typeof e?e:e.id)}getShapeLocalTransform(e){let t="string"==typeof e?e:e.id,i=this.getShape(t);if(!i)throw Error("Editor.getTransform: shape not found");return eG._.Identity().translate(i.x,i.y).rotate(i.rotation)}_getShapePageTransformCache(){return this.store.createComputedCache("pageTransformCache",e=>{if((0,eB.r5)(e.parentId))return this.getShapeLocalTransform(e);let t=this._getShapePageTransformCache().get(e.parentId)??eG._.Identity();return eG._.Compose(t,this.getShapeLocalTransform(e))})}getShapeParentTransform(e){let t="string"==typeof e?e:e.id,i=this.getShape(t);return!i||(0,eB.r5)(i.parentId)?eG._.Identity():this._getShapePageTransformCache().get(i.parentId)??eG._.Identity()}getShapePageTransform(e){let t="string"==typeof e?e:e.id;return this._getShapePageTransformCache().get(t)??eG._.Identity()}_getShapePageBoundsCache(){return this.store.createComputedCache("pageBoundsCache",e=>{let t=this.getShapePageTransform(e);if(!t)return;let i=this.getShapeGeometry(e);return eD.xu.FromPoints(t.applyToPoints(i.vertices))})}getShapePageBounds(e){return this._getShapePageBoundsCache().get("string"==typeof e?e:e.id)}_getShapeClipPathCache(){return this.store.createComputedCache("clipPathCache",e=>{let t=this._getShapeMaskCache().get(e.id);if(!t)return;if(0===t.length)return"polygon(0px 0px, 0px 0px, 0px 0px)";let i=this._getShapePageTransformCache().get(e.id);if(!i)return;let s=eG._.applyToPoints(eG._.Inverse(i),t);return`polygon(${s.map(e=>`${e.x}px ${e.y}px`).join(",")})`})}getShapeClipPath(e){return this._getShapeClipPathCache().get("string"==typeof e?e:e.id)}_getShapeMaskCache(){return this.store.createComputedCache("pageMaskCache",e=>{if((0,eB.r5)(e.parentId))return;let t=this.getShapeAncestors(e.id).filter(e=>this.isShapeOfType(e,"frame"));if(0===t.length)return;let i=t.map(e=>{let t=this.getShapeGeometry(e.id),i=this.getShapePageTransform(e.id);return i.applyToPoints(t.vertices)}).reduce((e,t)=>{if(!(t&&e))return;let i=(0,eY.tY)(e,t);return i?i.map(eH.B.Cast):[]});return i})}getShapeMask(e){return this._getShapeMaskCache().get("string"==typeof e?e:e.id)}getShapeMaskedPageBounds(e){return"string"!=typeof e&&(e=e.id),this._getShapeMaskedPageBoundsCache().get(e)}_getShapeMaskedPageBoundsCache(){return this.store.createComputedCache("shapeMaskedPageBoundsCache",e=>{let t=this._getShapePageBoundsCache().get(e.id);if(!t)return;let i=this._getShapeMaskCache().get(e.id);if(i){if(0===i.length)return;let{corners:e}=t;if(e.every((e,t)=>e&&eH.B.Equals(e,i[t])))return t.clone();let s=(0,eY.tY)(i,e);if(!s)return;return eD.xu.FromPoints(s)}return t})}getShapeAncestors(e,t=[]){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return t;let r=s.parentId;if((0,eB.r5)(r))return t.reverse(),t;let n=this.store.get(r);return n?(t.push(n),this.getShapeAncestors(n,t)):t}findShapeAncestor(e,t){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return;let r=s.parentId;if((0,eB.r5)(r))return;let n=this.getShape(r);if(n)return t(n)?n:this.findShapeAncestor(n,t)}hasAncestor(e,t){let i="string"==typeof e?e:e?.id,s=i&&this.getShape(i);return!!s&&(s.parentId===t||this.hasAncestor(this.getShapeParent(s),t))}findCommonAncestor(e,t){if(0===e.length)return;let i="string"==typeof e[0]?e:e.map(e=>e.id),s=(0,eF.oA)(i.map(e=>this.getShape(e)));if(1===s.length){let e=s[0].parentId;if((0,eB.r5)(e))return;return t?this.findShapeAncestor(s[0],t)?.id:e}let[r,...n]=s,a=this.getShapeParent(r);for(;a;){if(t&&!t(a)){a=this.getShapeParent(a);continue}if(n.every(e=>this.hasAncestor(e,a.id)))return a.id;a=this.getShapeParent(a)}}isShapeOrAncestorLocked(e){let t=e&&this.getShape(e);return void 0!==t&&(!!t.isLocked||this.isShapeOrAncestorLocked(this.getShapeParent(t)))}getNotVisibleShapes(){return this._notVisibleShapes.get()}getCulledShapes(){let e=this.getNotVisibleShapes(),t=this.getSelectedShapeIds(),i=this.getEditingShapeId(),s=new Set(e);return i&&s.delete(i),t.forEach(e=>{s.delete(e)}),s}getCurrentPageBounds(){let e;return this.getCurrentPageShapeIdsSorted().forEach(t=>{let i=this.getShapeMaskedPageBounds(t);i&&(e=e?e.expand(i):i.clone())}),e}getSelectedShapeAtPoint(e){let t=this.getSelectedShapeIds();return this.getCurrentPageShapesSorted().filter(e=>"group"!==e.type&&t.includes(e.id)).reverse().find(t=>this.isPointInShape(t,e,{hitInside:!0,margin:0}))}getShapeAtPoint(e,t={}){let i=this.getZoomLevel(),s=this.getViewportPageBounds(),{filter:r,margin:n=0,hitLocked:a=!1,hitLabels:h=!1,hitInside:o=!1,hitFrameInside:l=!1}=t,d=1/0,p=null,g=1/0,u=null,c=(t.renderingOnly?this.getCurrentPageRenderingShapesSorted():this.getCurrentPageShapesSorted()).filter(t=>{if(t.isLocked&&!a||this.isShapeHidden(t)||this.isShapeOfType(t,"group"))return!1;let i=this.getShapeMask(t);return(!i||!!(0,eX.Of)(e,i))&&(!r||r(t))});for(let t=c.length-1;t>=0;t--){let r;let a=c[t],S=this.getShapeGeometry(a),f=S instanceof eN.m,m=this.getPointInShapeSpace(a,e);if(this.isShapeOfType(a,"frame")||this.isShapeOfType(a,"arrow")&&a.props.text.trim()||(this.isShapeOfType(a,"note")||this.isShapeOfType(a,"geo")&&"none"===a.props.fill)&&this.getShapeUtil(a).getText(a)?.trim()){for(let e of S.children)if(e.isLabel&&e.isPointInBounds(m))return a}if(this.isShapeOfType(a,"frame")){let e=S.distanceToPoint(m,o);if(Math.abs(e)<=n)return u||a;if(S.hitTestPoint(m,0,!0))return u||p||(l?a:void 0);continue}if(f){let e=1/0;for(let t of S.children){if(t.isLabel&&!h)continue;let i=t.distanceToPoint(m,o);i<e&&(e=i)}r=e}else r=0===n&&(S.bounds.w<1||S.bounds.h<1)?S.distanceToPoint(m,o):S.bounds.containsPoint(m,n)?S.distanceToPoint(m,o):1/0;if(S.isClosed){if(r<=n){if(S.isFilled||f&&S.children[0].isFilled)return u||a;if(this.getShapePageBounds(a).contains(s))continue;if(Math.abs(r)<n)Math.abs(r)<g&&(g=Math.abs(r),u=a);else if(!u){let{area:e}=S;e<d&&(d=e,p=a)}}}else if(r<this.options.hitTestMargin/i)return a}return u||p||void 0}getShapesAtPoint(e,t={}){return this.getCurrentPageShapesSorted().filter(i=>!this.isShapeHidden(i)&&this.isPointInShape(i,e,t)).reverse()}isPointInShape(e,t,i={}){let{hitInside:s=!1,margin:r=0}=i,n="string"==typeof e?e:e.id,a=this.getShapeMask(n);return(!a||!!(0,eX.Of)(t,a))&&this.getShapeGeometry(n).hitTestPoint(this.getPointInShapeSpace(e,t),r,s)}getPointInShapeSpace(e,t){let i="string"==typeof e?e:e.id;return this._getShapePageTransformCache().get(i).clone().invert().applyToPoint(t)}getPointInParentSpace(e,t){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return new eH.B(0,0);if((0,eB.r5)(s.parentId))return eH.B.From(t);let r=this.getShapePageTransform(s.parentId);return r?r.clone().invert().applyToPoint(t):eH.B.From(t)}getCurrentPageShapes(){return Array.from(this.getCurrentPageShapeIds(),e=>this.store.get(e))}getCurrentPageShapesSorted(){let e=[],t=this.getSortedChildIdsForParent(this.getCurrentPageId());for(let i=0,s=t.length;i<s;i++)!function pushShapeWithDescendants(e,t,i){let s=e.getShape(t);if(!s)return;i.push(s);let r=e.getSortedChildIdsForParent(t);for(let t=0,s=r.length;t<s;t++)pushShapeWithDescendants(e,r[t],i)}(this,t[i],e);return e}getCurrentPageRenderingShapesSorted(){let e=this.getCulledShapes();return this.getCurrentPageShapesSorted().filter(({id:t})=>!e.has(t)&&!this.isShapeHidden(t))}isShapeOfType(e,t){let i="string"==typeof e?this.getShape(e):e;return!!i&&i.type===t}getShape(e){let t="string"==typeof e?e:e.id;if((0,eB.YT)(t))return this.store.get(t)}getShapeParent(e){let t="string"==typeof e?e:e?.id;if(!t)return;let i=this.getShape(t);if(void 0!==i&&(0,eB.YT)(i.parentId))return this.getShape(i.parentId)}getShapeNearestSibling(e,t){if(!t)return;if(t.parentId===e.parentId)return t;let i=this.findShapeAncestor(t,t=>t.parentId===e.parentId);return i}isShapeInPage(e,t=this.getCurrentPageId()){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return!1;let r=!1;if(s.parentId===t)r=!0;else{let e=this.getShape(s.parentId);for(;e;){if(e.parentId===t){r=!0;break}e=this.getShape(e.parentId)}}return r}getAncestorPageId(e){let t="string"==typeof e?e:e?.id,i=t&&this.getShape(t);if(i)return(0,eB.r5)(i.parentId)?i.parentId:this.getAncestorPageId(this.getShape(i.parentId))}reparentShapes(e,t,i){let s="string"==typeof e[0]?e:e.map(e=>e.id);if(0===s.length)return this;let r=[],n=(0,eB.r5)(t)?eG._.Identity():this.getShapePageTransform(t),a=n.rotation(),h=[],o=(0,eF.oA)(this.getSortedChildIdsForParent(t).map(e=>this.getShape(e)));if(i){let e=o.find(e=>e.index===i);if(e){let t=o[o.indexOf(e)+1];h=t?(0,eF.Xv)(i,t.index,s.length):(0,eF.vw)(i,s.length)}else{let e=o.sort(eF.hl).find(e=>e.index>i);h=e?(0,eF.Xv)(i,e.index,s.length):(0,eF.vw)(i,s.length)}}else{let e=o.length&&o[o.length-1];h=e?(0,eF.vw)(e.index,s.length):(0,eF.H$)(s.length)}let l=n.clone().invert(),d=(0,eF.oA)(s.map(e=>this.getShape(e))).sort(eF.hl);return this.run(()=>{for(let e=0;e<d.length;e++){let i=d[e],s=this.getShapePageTransform(i);if(!s)continue;let n=s.point();if(!n)continue;let o=l.applyToPoint(n),p=s.rotation()-a;if(i.id===t)throw Error("Attempted to reparent a shape to itself!");r.push({id:i.id,type:i.type,parentId:t,x:o.x,y:o.y,rotation:p,index:h[e]})}this.updateShapes(r)},{ignoreShapeLock:!0}),this}getHighestIndexForParent(e){let t="string"==typeof e?e:e.id,i=this._parentIdsToChildIds.get()[t];if(!i||0===i.length)return"a1";let s=this.getShape(i[i.length-1]);return(0,eF._L)(s.index)}getSortedChildIdsForParent(e){let t="string"==typeof e?e:e.id,i=this._parentIdsToChildIds.get()[t];return i||eb.LZ}visitDescendants(e,t){let i=this.getSortedChildIdsForParent(e);for(let e of i)!1!==t(e)&&this.visitDescendants(e,t);return this}getShapeAndDescendantIds(e){let t=new Set;for(let i of e.map(e=>this.getShape(e)).sort(eF.hl))t.add(i.id),this.visitDescendants(i,e=>{t.add(e)});return t}getDroppingOverShape(e,t){return this.getDraggingOverShape(e,t)}getDraggingOverShape(e,t){let i=(0,eF.oA)(t.map(e=>this.getShape(e))).filter(e=>!e.isLocked&&!this.isShapeHidden(e)),s=this.getShapesAtPoint(e,{hitInside:!0,margin:0}).filter(e=>!t.includes(e)&&!e.isLocked&&!this.isShapeHidden(e)&&!i.includes(e));for(let e of s){let t=this.getShapeUtil(e);if(t.onDragShapesOver||t.onDragShapesIn||t.onDragShapesOut||t.onDropShapesOver)return e}}getOutermostSelectableShape(e,t){let i="string"==typeof e?e:e.id,s=this.getShape(i),r=s,n=s,a=this.getFocusedGroup();for(;n;){if(this.isShapeOfType(n,"group")&&a?.id!==n.id&&!this.hasAncestor(a,n.id)&&(t?.(n)??!0))r=n;else if(a?.id===n.id)break;n=this.getShapeParent(n)}return r}_getBindingsIndexCache(){let e=(0,e5.f)(this);return this.store.createComputedCache("bindingsIndex",t=>e.get().get(t.id),{areRecordsEqual:()=>!0})}getBinding(e){return this.store.get(e)}getBindingsFromShape(e,t){let i="string"==typeof e?e:e.id;return this.getBindingsInvolvingShape(i).filter(e=>e.fromId===i&&e.type===t)}getBindingsToShape(e,t){let i="string"==typeof e?e:e.id;return this.getBindingsInvolvingShape(i).filter(e=>e.toId===i&&e.type===t)}getBindingsInvolvingShape(e,t){let i="string"==typeof e?e:e.id,s=this._getBindingsIndexCache().get(i)??eb.LZ;return t?s.filter(e=>e.type===t):s}createBindings(e){let t=[];for(let i of e){let e=this.getShape(i.fromId),s=this.getShape(i.toId);if(!e||!s||!this.canBindShapes({fromShape:e,toShape:s,binding:i}))continue;let r=this.getBindingUtil(i.type),n=r.getDefaultProps(),a=this.store.schema.types.binding.create({...i,id:i.id??(0,eB.vI)(),props:{...n,...i.props}});t.push(a)}return this.store.put(t),this}createBinding(e){return this.createBindings([e])}updateBindings(e){let t=[];for(let i of e){if(!i)continue;let e=this.getBinding(i.id);if(!e)continue;let s=applyPartialToRecordWithProps(e,i);if(s===e)continue;let r=this.getShape(s.fromId),n=this.getShape(s.toId);r&&n&&this.canBindShapes({fromShape:r,toShape:n,binding:s})&&t.push(s)}return this.store.put(t),this}updateBinding(e){return this.updateBindings([e])}deleteBindings(e,{isolateShapes:t=!1}={}){let i=e.map(e=>"string"==typeof e?e:e.id);return t?this.store.atomic(()=>{for(let e of i){let t=this.getBinding(e);if(!t)continue;let i=this.getBindingUtil(t);i.onBeforeIsolateFromShape?.({binding:t,removedShape:this.getShape(t.toId)}),i.onBeforeIsolateToShape?.({binding:t,removedShape:this.getShape(t.fromId)}),this.store.remove([e])}}):this.store.remove(i),this}deleteBinding(e,t){return this.deleteBindings([e],t)}canBindShapes({fromShape:e,toShape:t,binding:i}){let s="string"==typeof e?e:e.type,r="string"==typeof t?t:t.type,n="string"==typeof i?i:i.type,a={fromShapeType:s,toShapeType:r,bindingType:n};return s===r?this.getShapeUtil(s).canBind(a):this.getShapeUtil(s).canBind(a)&&this.getShapeUtil(r).canBind(a)}rotateShapesBy(e,t,i){let s="string"==typeof e[0]?e:e.map(e=>e.id);if(s.length<=0)return this;let r=(0,e2.o)({editor:this,ids:s});return r&&(0,e2.Z)({delta:t,snapshot:r,editor:this,stage:"one-off",centerOverride:i?.center}),this}getChangesToTranslateShape(e,t){let i=e,s=this.getShapeUtil(e),r=s.onTranslateStart?.(i);r&&(i=applyPartialToRecordWithProps(i,r)),i=applyPartialToRecordWithProps(i,{id:e.id,type:e.type,x:t.x,y:t.y});let n=s.onTranslate?.(e,i);n&&(i=applyPartialToRecordWithProps(i,n));let a=s.onTranslateEnd?.(e,i);return a&&(i=applyPartialToRecordWithProps(i,a)),i}nudgeShapes(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(i.length<=0)return this;let s=[];for(let e of i){let i=this.getShape(e),r=eH.B.From(t),n=this.getShapeParentTransform(i);n&&r.rot(-n.rotation()),s.push(this.getChangesToTranslateShape(i,r.add(i)))}return this.updateShapes(s),this}duplicateShapes(e,t){return this.run(()=>{let i="string"==typeof e[0]?e:e.map(e=>e.id),s=this._shouldIgnoreShapeLock?i:this._getUnlockedShapeIds(i);if(s.length<=0)return this;let r=new Set(s),n=this.getShapeAndDescendantIds(s),a=[...n].reverse(),h=new Map;for(let e of n)h.set(e,(0,eB.F1)());let{shapesToCreateWithOriginals:o,bindingsToCreate:l}=withIsolatedShapes(this,n,e=>{let i=[];for(let t of e){let e=this.getBinding(t);if(!e)continue;let s=(0,eB.vI)();i.push({...e,id:s,fromId:(0,eF.kP)(h.get(e.fromId)),toId:(0,eF.kP)(h.get(e.toId))})}let s=[];for(let e of a){let i=(0,eF.kP)(h.get(e)),n=this.getShape(e);if(!n)continue;let a=0,o=0;if(t&&r.has(e)){let e=this.getShapeParentTransform(n),i=new eH.B(t.x,t.y).rot(-e.rotation());a=i.x,o=i.y}s.push({shape:{...n,id:i,x:n.x+a,y:n.y+o,index:"a1",parentId:h.get(n.parentId)??n.parentId},originalShape:n})}return{shapesToCreateWithOriginals:s,bindingsToCreate:i}});o.forEach(({shape:e,originalShape:t})=>{let i=t.parentId,s=this.getSortedChildIdsForParent(i),r=s.indexOf(t.id),n=s[r+1],a=n?this.getShape(n):void 0,h=(0,eF.eI)(t.index,a?.index);e.index=h});let d=o.map(({shape:e})=>e);if(!this.canCreateShapes(d)){alertMaxShapes(this);return}if(this.createShapes(d),this.createBindings(l),this.setSelectedShapes((0,eF.oA)(s.map(e=>h.get(e)))),void 0!==t){let e=this.getSelectionPageBounds(),t=this.getViewportPageBounds();e&&!t.contains(e)&&this.centerOnPoint(e.center,{animation:{duration:this.options.animationMediumMs}})}}),this}moveShapesToPage(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(0===i.length||this.getIsReadonly())return this;let s=this.getCurrentPageId();if(t===s||!this.store.has(t))return this;let r=this.getContentFromCurrentPage(i);if(!r)return this;if(this.getPageShapeIds(t).size+r.shapes.length>this.options.maxShapesPerPage)return alertMaxShapes(this,t),this;let n=this.getCamera().z;return this.run(()=>{this.deleteShapes(i),this.setCurrentPage(t),this.setFocusedGroup(null),this.selectNone(),this.putContentOntoCurrentPage(r,{select:!0,preserveIds:!0,preservePosition:!0}),this.setCamera({...this.getCamera(),z:n}),this.centerOnPoint(this.getSelectionRotatedPageBounds().center)}),this}toggleLock(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getIsReadonly()||0===t.length)return this;let i=!0,s=!0,r=[];for(let e of t){let t=this.getShape(e);t&&(r.push(t),t.isLocked?s=!1:i=!1)}return this.run(()=>{s?(this.updateShapes(r.map(e=>({id:e.id,type:e.type,isLocked:!0}))),this.setSelectedShapes([])):i?this.updateShapes(r.map(e=>({id:e.id,type:e.type,isLocked:!1}))):this.updateShapes(r.map(e=>({id:e.id,type:e.type,isLocked:!0})))}),this}sendToBack(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,e1.B)(this,"toBack",t,{considerAllShapes:!0});return i&&this.updateShapes(i),this}sendBackward(e,t={}){let i="string"==typeof e[0]?e:e.map(e=>e.id),s=(0,e1.B)(this,"backward",i,t);return s&&this.updateShapes(s),this}bringForward(e,t={}){let i="string"==typeof e[0]?e:e.map(e=>e.id),s=(0,e1.B)(this,"forward",i,t);return s&&this.updateShapes(s),this}bringToFront(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,e1.B)(this,"toFront",t);return i&&this.updateShapes(i),this}collectShapesViaArrowBindings(e){let{initialShapes:t,resultShapes:i,resultBounds:s,bindings:r,visited:n}=e;for(let a of r)for(let r of[a.fromId,a.toId])if(!n.has(r)){let a=t.find(e=>e.id===r);if(a&&!n.has(a.id)){n.add(a.id);let t=this.getShapePageBounds(a);if(!t)continue;i.push(a),s.push(t),this.collectShapesViaArrowBindings({...e,bindings:this.getBindingsInvolvingShape(a,"arrow")})}}}flipShapes(e,t){if(this.getIsReadonly())return this;let i="string"==typeof e[0]?e:e.map(e=>e.id),s=(0,eF.oA)(i.map(e=>this.getShape(e)));for(let e of s)if(this.isShapeOfType(e,"group")){let t=(0,eF.oA)(this.getSortedChildIdsForParent(e.id).map(e=>this.getShape(e)));s.push(...t)}let r=[],n=[];for(let e of s){let t=this.getShapeUtil(e);if(!t.canBeLaidOut(e,{type:"flip",shapes:s}))continue;let i=this.getShapePageBounds(e),a=this.getShapeGeometry(e).bounds,h=this.getShapePageTransform(e.id);i&&a&&h&&(r.push({shape:e,localBounds:a,pageTransform:h,isAspectRatioLocked:t.isAspectRatioLocked(e)}),n.push(i))}if(!r.length)return this;let a=eD.xu.Common(n).center;return this.run(()=>{for(let{shape:e,localBounds:i,pageTransform:s,isAspectRatioLocked:n}of r)this.resizeShape(e.id,{x:"horizontal"===t?-1:1,y:"vertical"===t?-1:1},{initialBounds:i,initialPageTransform:s,initialShape:e,isAspectRatioLocked:n,mode:"scale_shape",scaleOrigin:a,scaleAxisRotation:0})}),this}stackShapes(e,t,i){let s,r,n,a;let h=i??this.options.adjacentShapeMargin,o="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getIsReadonly())return this;let l=(0,eF.oA)(o.map(e=>this.getShape(e))),d=[],p=[],g=new Set;for(let e of l){if(g.has(e.id))continue;g.add(e.id);let t=this.getShapePageBounds(e);if(!t||!this.getShapeUtil(e).canBeLaidOut?.(e,{type:"stack",shapes:l}))continue;let i=[e],s=[t];this.collectShapesViaArrowBindings({bindings:this.getBindingsToShape(e.id,"arrow"),initialShapes:l,resultShapes:i,resultBounds:s,visited:g});let r=eD.xu.Common(s);r&&(d.push({shapes:i,pageBounds:r}),p.push(r))}let u=d.length;if(0===h&&u<3||u<2)return this;"horizontal"===t?(s="x",r="minX",n="maxX",a="width"):(s="y",r="minY",n="maxY",a="height");let c=0;if(0===h){let e={};d.sort((e,t)=>e.pageBounds[r]-t.pageBounds[r]);for(let t=0;t<u-1;t++){let i=d[t],s=d[t+1],a=s.pageBounds[r]-i.pageBounds[n];e[a]||(e[a]=0),e[a]++}let t=1;for(let[i,s]of Object.entries(e))s>t&&(t=s,c=parseFloat(i));if(1===t){let t=0;for(let[i,s]of Object.entries(e))c+=parseFloat(i)*s,t+=s;c/=t}}else c=h;let S=[],f=d[0].pageBounds[n];for(let e=1;e<d.length;e++){let{shapes:t,pageBounds:i}=d[e],r=new eH.B;for(let e of(r[s]=f+c-i[s],t)){let t=r.clone(),i=this.getShapeParent(e);if(i){let e=this.getShapePageTransform(i);e&&t.rot(-e.rotation())}t.add(e),S.push(this.getChangesToTranslateShape(e,t))}f+=i[a]+c}return this.updateShapes(S),this}packShapes(e,t){let i,s;if(this.getIsReadonly())return this;let r=t??this.options.adjacentShapeMargin,n="string"==typeof e[0]?e:e.map(e=>e.id),a=(0,eF.oA)(n.map(e=>this.getShape(e))),h=[],o=[],l=new Set;for(let e of a){if(l.has(e.id))continue;l.add(e.id);let t=this.getShapePageBounds(e);if(!t||!this.getShapeUtil(e).canBeLaidOut?.(e,{type:"pack",shapes:a}))continue;let i=[e],s=[t];this.collectShapesViaArrowBindings({bindings:this.getBindingsToShape(e.id,"arrow"),initialShapes:a,resultShapes:i,resultBounds:s,visited:l});let r=eD.xu.Common(s);r&&(h.push({shapes:i,pageBounds:r,nextPageBounds:r.clone()}),o.push(r))}if(h.length<2)return this;let d=0;for(let{pageBounds:e}of h)d+=e.width*e.height;let p=eD.xu.Common(o),g=p.width;h.sort((e,t)=>e.pageBounds.width-t.pageBounds.width).sort((e,t)=>e.pageBounds.height-t.pageBounds.height);let u=Math.max(Math.ceil(Math.sqrt(d/.95)),g),c=[new eD.xu(p.x,p.y,u,1/0)],S=0,f=0;for(let{nextPageBounds:e}of h)for(let t=c.length-1;t>=0;t--)if(i=c[t],!(e.width>i.width)&&!(e.height>i.height)){e.x=i.x,e.y=i.y,f=Math.max(f,e.maxY),S=Math.max(S,e.maxX),e.width===i.width&&e.height===i.height?(s=c.pop(),t<c.length&&(c[t]=s)):e.height===i.height?(i.x+=e.width+r,i.width-=e.width+r):(e.width===i.width||c.push(new eD.xu(i.x+(e.width+r),i.y,i.width-(e.width+r),e.height)),i.y+=e.height+r,i.height-=e.height+r);break}let m=eD.xu.Common(h.map(e=>e.nextPageBounds)),y=eH.B.Sub(p.center,m.center),_=[];for(let{shapes:e,pageBounds:t,nextPageBounds:i}of h){let s=eH.B.Sub(i.point,t.point).add(y);for(let t of e){let e=s.clone(),i=this.getShapeParent(t);if(i){let i=this.getShapeParentTransform(t);i&&e.rot(-i.rotation())}e.add(t),_.push(this.getChangesToTranslateShape(t,e))}}return _.length&&this.updateShapes(_),this}alignShapes(e,t){if(this.getIsReadonly())return this;let i="string"==typeof e[0]?e:e.map(e=>e.id),s=(0,eF.oA)(i.map(e=>this.getShape(e))),r=[],n=[],a=new Set;for(let e of s){if(a.has(e.id))continue;a.add(e.id);let t=this.getShapePageBounds(e);if(!t||!this.getShapeUtil(e).canBeLaidOut?.(e,{type:"align",shapes:s}))continue;let i=[e],h=[t];this.collectShapesViaArrowBindings({bindings:this.getBindingsToShape(e.id,"arrow"),initialShapes:s,resultShapes:i,resultBounds:h,visited:a});let o=eD.xu.Common(h);o&&(r.push({shapes:i,pageBounds:o}),n.push(o))}if(r.length<2)return this;let h=eD.xu.Common(n),o=[];return r.forEach(({shapes:e,pageBounds:i})=>{let s=new eH.B;switch(t){case"top":s.y=h.minY-i.minY;break;case"center-vertical":s.y=h.midY-i.minY-i.height/2;break;case"bottom":s.y=h.maxY-i.minY-i.height;break;case"left":s.x=h.minX-i.minX;break;case"center-horizontal":s.x=h.midX-i.minX-i.width/2;break;case"right":s.x=h.maxX-i.minX-i.width}for(let t of e){let e=s.clone(),i=this.getShapeParent(t);if(i){let t=this.getShapePageTransform(i);t&&e.rot(-t.rotation())}e.add(t),o.push(this.getChangesToTranslateShape(t,e))}}),this.updateShapes(o),this}distributeShapes(e,t){let i,s,r,n;if(this.getIsReadonly())return this;let a="string"==typeof e[0]?e:e.map(e=>e.id),h=(0,eF.oA)(a.map(e=>this.getShape(e))),o=[],l=[],d=new Set;for(let e of h){if(d.has(e.id))continue;d.add(e.id);let t=this.getShapePageBounds(e);if(!t||!this.getShapeUtil(e).canBeLaidOut?.(e,{type:"distribute",shapes:h}))continue;let i=[e],s=[t];this.collectShapesViaArrowBindings({bindings:this.getBindingsToShape(e.id,"arrow"),initialShapes:h,resultShapes:i,resultBounds:s,visited:d});let r=eD.xu.Common(s);r&&(o.push({shapes:i,pageBounds:r}),l.push(r))}if(o.length<3)return this;"horizontal"===t?(i="x",s="minX",r="maxX",n="width"):(i="y",s="minY",r="maxY",n="height");let p=[],g=o.sort((e,t)=>e.pageBounds[s]-t.pageBounds[s])[0],u=o.sort((e,t)=>t.pageBounds[r]-e.pageBounds[r])[0];if(g===u){let e=new Set(g.shapes.map(e=>e.id));return this.distributeShapes(a.filter(t=>!e.has(t)),t)}let c=o.filter(e=>e!==g&&e!==u).sort((e,t)=>e.pageBounds[s]===t.pageBounds[s]?e.shapes[0].id<t.shapes[0].id?-1:1:e.pageBounds[s]-t.pageBounds[s]),S=g.pageBounds[r],f=u.pageBounds[s]-S,m=c.reduce((e,t)=>e+t.pageBounds[n],0),y=(f-m)/(c.length+1);for(let e=S+y,t=0;t<c.length;t++){let{shapes:s,pageBounds:a}=c[t],h=new eH.B;for(let t of(h[i]=e-a[i],e+a[n]>u.pageBounds[r]-1&&(h[i]=u.pageBounds[r]-a[r]-1),s)){let e=h.clone(),i=this.getShapeParent(t);if(i){let t=this.getShapePageTransform(i);t&&e.rot(-t.rotation())}e.add(t),p.push(this.getChangesToTranslateShape(t,e))}e+=a[n]+y}return this.updateShapes(p),this}stretchShapes(e,t){let i,s,r;let n="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getIsReadonly())return this;let a=(0,eF.oA)(n.map(e=>this.getShape(e))).filter(e=>this.getShapePageTransform(e)?.rotation()%(eX.PI/2)==0),h=[],o=[],l=new Set;for(let e of a){if(l.has(e.id))continue;l.add(e.id);let t=this.getShapePageBounds(e);if(!t)continue;let i=[e],s=[t];if(!this.getShapeUtil(e).canBeLaidOut?.(e,{type:"stretch",shapes:a}))continue;this.collectShapesViaArrowBindings({bindings:this.getBindingsToShape(e.id,"arrow"),initialShapes:a,resultShapes:i,resultBounds:s,visited:l});let r=eD.xu.Common(s);r&&(h.push({shapes:i,pageBounds:r}),o.push(r))}if(h.length<2)return this;let d=eD.xu.Common(o);return"horizontal"===t?(i="x",s="minX",r="width"):(i="y",s="minY",r="height"),this.run(()=>{h.forEach(({shapes:e,pageBounds:t})=>{let n=new eH.B;n[i]=d[s]-t[s];let a=t.center.clone();a[i]=d[s];let h=new eH.B(1,1);for(let s of(h[i]=d[r]/t[r],e)){let e=n.clone(),t=this.getShapeParentTransform(s);t&&n.rot(-t.rotation()),e.add(s);let i=this.getChangesToTranslateShape(s,e);this.updateShape(i),this.resizeShape(s.id,h,{initialBounds:this.getShapeGeometry(s).bounds,scaleOrigin:a,isAspectRatioLocked:this.getShapeUtil(s).isAspectRatioLocked(s),scaleAxisRotation:0})}})}),this}resizeShape(e,t,i={}){let s="string"==typeof e?e:e.id;if(this.getIsReadonly())return this;Number.isFinite(t.x)||(t=new eH.B(1,t.y)),Number.isFinite(t.y)||(t=new eH.B(t.x,1));let r=i.initialShape??this.getShape(s);if(!r)return this;let n=i.scaleOrigin??this.getShapePageBounds(s)?.center;if(!n)return this;let a=i.initialPageTransform?eG._.Cast(i.initialPageTransform):this.getShapePageTransform(s);if(!a)return this;let h=a.rotation();if(null==h)return this;let o=i.scaleAxisRotation??h,l=i.initialBounds??this.getShapeGeometry(s).bounds;if(!l)return this;let d=i.isAspectRatioLocked??this.getShapeUtil(r).isAspectRatioLocked(r);if(!(0,eX._G)(h,o))return this._resizeUnalignedShape(s,t,{...i,initialBounds:l,scaleOrigin:n,scaleAxisRotation:o,initialPageTransform:a,isAspectRatioLocked:d,initialShape:r});let p=this.getShapeUtil(r);d&&(t=Math.abs(t.x)>Math.abs(t.y)?new eH.B(t.x,Math.sign(t.y)*Math.abs(t.x)):new eH.B(Math.sign(t.x)*Math.abs(t.y),t.y));let g=!1;if(p.onResize&&p.canResize(r)){let e=this._scalePagePoint(eG._.applyToPoint(a,new eH.B(0,0)),n,t,o),d=this.getPointInParentSpace(r.id,e),u=new eH.B(t.x,t.y),c=(0,eX.C2)((h-o)%Math.PI,0);u.x=c?t.x:t.y,u.y=c?t.y:t.x;let S=eG._.applyToPoint(a,new eH.B),{x:f,y:m}=this.getPointInParentSpace(r.id,S),y=r;i.skipStartAndEndCallbacks||(y=applyPartialToRecordWithProps(r,p.onResizeStart?.(r)??void 0));let _=p.onResize({...r,x:f,y:m},{newPoint:d,handle:i.dragHandle??"bottom_right",mode:i.mode??"scale_shape",scaleX:u.x,scaleY:u.y,initialBounds:l,initialShape:r});_&&(g=!0),y=applyPartialToRecordWithProps(y,{id:s,type:r.type,x:d.x,y:d.y,..._}),i.skipStartAndEndCallbacks||(y=applyPartialToRecordWithProps(y,p.onResizeEnd?.(r,y)??void 0)),this.updateShapes([y])}if(!g){let e=eG._.applyToPoint(a,l.center),i=this._scalePagePoint(e,n,t,o),h=this.getPointInParentSpace(r.id,e),d=this.getPointInParentSpace(r.id,i),p=eH.B.Sub(d,h);this.updateShapes([{id:s,type:r.type,x:r.x+p.x,y:r.y+p.y}])}return this}_scalePagePoint(e,t,i,s){let r=eH.B.RotWith(e,t,-s).sub(t),n=eH.B.MulV(r,i),a=eH.B.Add(n,t).rotWith(t,s);return a}_resizeUnalignedShape(e,t,i){let{type:s}=i.initialShape,r=new eH.B(t.x,t.y);if(Math.abs(t.x)>Math.abs(t.y)?r.x=Math.sign(t.x)*Math.abs(t.y):r.y=Math.sign(t.y)*Math.abs(t.x),this.resizeShape(e,r,{initialShape:i.initialShape,initialBounds:i.initialBounds,isAspectRatioLocked:i.isAspectRatioLocked}),Math.sign(t.x)*Math.sign(t.y)<0){let{rotation:t}=eG._.Decompose(i.initialPageTransform);t-=2*t,this.updateShapes([{id:e,type:s,rotation:t}])}let n=eG._.applyToPoint(i.initialPageTransform,i.initialBounds.center),a=this._scalePagePoint(n,i.scaleOrigin,t,i.scaleAxisRotation),h=this.getShapePageBounds(e),o=this.getShapePageTransform(e),l=h.center,d=o.point();if(!l||!d)return this;let p=eH.B.Sub(a,l),g=eH.B.Add(d,p),{x:u,y:c}=this.getPointInParentSpace(e,g);return this.updateShapes([{id:e,type:s,x:u,y:c}]),this}getInitialMetaForShape(e){return{}}canCreateShape(e){return this.canCreateShapes([e])}canCreateShapes(e){return e.length+this.getCurrentPageShapeIds().size<=this.options.maxShapesPerPage}createShape(e){return this.createShapes([e]),this}createShapes(e){if(!Array.isArray(e))throw Error("Editor.createShapes: must provide an array of shapes or shape partials");if(this.getIsReadonly()||e.length<=0)return this;let t=this.getCurrentPageShapeIds(),i=e.length+t.size>this.options.maxShapesPerPage;if(i)return alertMaxShapes(this),this;let s=this.getFocusedGroupId();return this.run(()=>{let t=this.getCurrentPageShapesSorted(),i=e.map(i=>{if(i.id||(i={id:(0,eB.F1)(),...i}),!i.parentId||!(this.store.has(i.parentId)||e.some(e=>e.id===i.parentId))){let e=this.getFocusedGroupId();for(let s=t.length-1;s>=0;s--){let r=t[s],n=this.getShapeUtil(r);if(n.canReceiveNewChildrenOfType(r,i.type)&&!this.isShapeHidden(r)&&this.isPointInShape(r,{x:i.x??0,y:i.y??0},{margin:0,hitInside:!0})){e=r.id;break}}let r=i.parentId;if(e===i.id&&(e=s),e!==r&&((i={...i}).parentId=e,(0,eB.YT)(e))){let t=this.getPointInShapeSpace(this.getShape(e),{x:i.x??0,y:i.y??0});i.x=t.x,i.y=t.y,i.rotation=-this.getShapePageTransform(e).rotation()+(i.rotation??0)}}return i}),r=new Map,n=[],{opacityForNextShape:a}=this.getInstanceState();for(let e of i){let t=this.getShapeUtil(e),i=e.index;if(!i){let t=e.parentId??s;r.has(t)||r.set(t,this.getHighestIndexForParent(t)),i=r.get(t),r.set(t,(0,eF._L)(i))}let h=t.getDefaultProps();for(let[t,i]of this.styleProps[e.type])h[i]=this.getStyleForNextShape(t);let o=this.store.schema.types.shape.create({...e,index:i,opacity:e.opacity??a,parentId:e.parentId??s,props:"props"in e?{...h,...e.props}:h});if(void 0===o.index)throw Error("no index!");let l=this.getShapeUtil(o).onBeforeCreate?.(o);l&&(o=l),n.push(o)}n.forEach(e=>{e.meta={...this.getInitialMetaForShape(e),...e.meta}}),this.emit("created-shapes",n),this.emit("edit"),this.store.put(n)}),this}animateShape(e,t={animation:eO.Xy}){return this.animateShapes([e],t)}animateShapes(e,t={animation:eO.Xy}){let i,s,r;if(!t.animation)return this;let{duration:n=500,easing:a=eZ.L.linear}=t.animation,h=(0,eF.EL)(),o=n,l=[];for(let t=0,i=e.length;t<i;t++){if(!(s=e[t]))continue;let i=this.getShape(s.id);i&&(r={start:(0,eF.v4)(i),end:applyPartialToRecordWithProps((0,eF.v4)(i),s)},l.push(r),this.animatingShapes.set(i.id,h))}let handleTick=t=>{if((o-=t)<0){let{animatingShapes:t}=this,i=e.filter(e=>e&&t.get(e.id)===h);i.length&&this.updateShapes(i),this.off("tick",handleTick);return}i=a(1-o/n);let{animatingShapes:s}=this,r=[];for(let e=0,t=l.length;e<t;e++){let{start:t,end:n}=l[e];s.get(t.id)===h&&r.push({...n,x:t.x+(n.x-t.x)*i,y:t.y+(n.y-t.y)*i,opacity:t.opacity+(n.opacity-t.opacity)*i,rotation:t.rotation+(n.rotation-t.rotation)*i,props:this.getShapeUtil(n).getInterpolatedProps?.(t,n,i)??n.props})}this._updateShapes(r)};return this.on("tick",handleTick),this}groupShapes(e,t={}){let{groupId:i=(0,eB.F1)(),select:s=!0}=t;if(!Array.isArray(e))throw Error("Editor.groupShapes: must provide an array of shapes or shape ids");if(this.getIsReadonly())return this;let r="string"==typeof e[0]?e:e.map(e=>e.id);if(r.length<=1)return this;let n=(0,eF.oA)((this._shouldIgnoreShapeLock?r:this._getUnlockedShapeIds(r)).map(e=>this.getShape(e))),a=n.sort(eF.hl).map(e=>e.id),h=eD.xu.Common((0,eF.oA)(n.map(e=>this.getShapePageBounds(e)))),{x:o,y:l}=h.point,d=this.findCommonAncestor(n)??this.getCurrentPageId();if("select"!==this.getCurrentToolId())return this;this.isIn("select.idle")||this.cancel();let p=n.filter(e=>e.parentId===d).sort(eF.hl),g=p[p.length-1]?.index;return this.run(()=>{this.createShapes([{id:i,type:"group",parentId:d,index:g,x:o,y:l,opacity:1,props:{}}]),this.reparentShapes(a,i),s&&this.select(i)}),this}ungroupShapes(e,t={}){if(this.getIsReadonly())return this;let{select:i=!0}=t,s="string"==typeof e[0]?e:e.map(e=>e.id),r=(0,eF.oA)((this._shouldIgnoreShapeLock?s:this._getUnlockedShapeIds(s)).map(e=>this.getShape(e)));if(0===r.length||"select"!==this.getCurrentToolId())return this;this.isIn("select.idle")||this.cancel();let n=new Set,a=[];return r.forEach(e=>{this.isShapeOfType(e,"group")?a.push(e):n.add(e.id)}),0===a.length||this.run(()=>{let e;for(let t=0,i=a.length;t<i;t++){e=a[t];let i=this.getSortedChildIdsForParent(e.id);for(let e=0,t=i.length;e<t;e++)n.add(i[e]);this.reparentShapes(i,e.parentId,e.index)}this.deleteShapes(a.map(e=>e.id)),i&&this.select(...n)}),this}updateShape(e){return this.updateShapes([e]),this}updateShapes(e){let t=Array(e.length);for(let i=0,s=e.length;i<s;i++){let s=e[i];if(!s)continue;let r=this.getShape(s.id);if(r){if(!this._shouldIgnoreShapeLock){if(r.isLocked){if(!(Object.hasOwn(s,"isLocked")&&!s.isLocked))continue}else if(this.isShapeOrAncestorLocked(r))continue}this.animatingShapes.delete(s.id),t.push(s)}}return this._updateShapes(t),this}_updateShapes(e){this.getIsReadonly()||this.run(()=>{let t,i;let s=[];for(let r=0,n=e.length;r<n;r++){let n=e[r];n&&(t=this.getShape(n.id))&&(i=applyPartialToRecordWithProps(t,n))!==t&&(i=this.getShapeUtil(t).onBeforeUpdate?.(t,i)??i,s.push(i))}this.emit("edited-shapes",s),this.emit("edit"),this.store.put(s)})}_getUnlockedShapeIds(e){return e.filter(e=>!this.getShape(e)?.isLocked)}deleteShapes(e){if(this.getIsReadonly())return this;if(!Array.isArray(e))throw Error("Editor.deleteShapes: must provide an array of shapes or shapeIds");let t="string"==typeof e[0]?e:e.map(e=>e.id),i=this._shouldIgnoreShapeLock?t:this._getUnlockedShapeIds(t);if(0===i.length)return this;let s=new Set(i);for(let e of i)this.visitDescendants(e,e=>{s.add(e)});return this.emit("deleted-shapes",[...s]),this.emit("edit"),this.run(()=>this.store.remove([...s]))}deleteShape(e){return this.deleteShapes(["string"==typeof e?e:e.id]),this}_extractSharedStyles(e,t){if(this.isShapeOfType(e,"group")){let i=this._parentIdsToChildIds.get()[e.id];if(i)for(let e=0,s=i.length;e<s;e++)this._extractSharedStyles(this.getShape(i[e]),t)}else for(let[i,s]of this.styleProps[e.type])t.applyValue(i,(0,eF.eg)(e.props,s))}_getSelectionSharedStyles(){let e=this.getSelectedShapes(),t=new eW.o;for(let i of e)this._extractSharedStyles(i,t);return t}getStyleForNextShape(e){let t=this.getInstanceState().stylesForNextShape[e.id];return void 0===t?e.defaultValue:t}getShapeStyleIfExists(e,t){let i=this.styleProps[e.type].get(t);if(void 0!==i)return(0,eF.eg)(e.props,i)}getSharedStyles(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0)return this._getSelectionSharedStyles();let e=this.root.getCurrent(),t=new eW.o;if(!e)return t;if(e.shapeType){if("frame"!==e.shapeType||this.getShapeUtil("frame").options.showColors)for(let i of this.styleProps[e.shapeType].keys())t.applyValue(i,this.getStyleForNextShape(i));else for(let i of this.styleProps[e.shapeType].keys())"tldraw:color"!==i.id&&t.applyValue(i,this.getStyleForNextShape(i))}return t}getSharedOpacity(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0){let e=[],addShape=t=>{let i=this.getShape(t);if(i){if(this.isShapeOfType(i,"group"))for(let e of this.getSortedChildIdsForParent(i.id))addShape(e);else e.push(i)}};for(let e of this.getSelectedShapeIds())addShape(e);let t=null;for(let i of e)if(null===t)t=i.opacity;else if(t!==i.opacity)return{type:"mixed"};if(null!==t)return{type:"shared",value:t}}return{type:"shared",value:this.getInstanceState().opacityForNextShape}}setOpacityForNextShapes(e,t){return this.updateInstanceState({opacityForNextShape:e},t),this}setOpacityForSelectedShapes(e){let t=this.getSelectedShapes();if(t.length>0){let i=[],addShapeById=e=>{if(this.isShapeOfType(e,"group")){let t=this.getSortedChildIdsForParent(e);for(let e of t)addShapeById(this.getShape(e))}else i.push(e)};for(let e of t)addShapeById(e);this.updateShapes(i.map(t=>({id:t.id,type:t.type,opacity:e})))}return this}setStyleForNextShapes(e,t,i){let s=this.getInstanceState().stylesForNextShape;return this.updateInstanceState({stylesForNextShape:{...s,[e.id]:t}},i),this}setStyleForSelectedShapes(e,t){let i=this.getSelectedShapes();if(i.length>0){let s=[],addShapeById=i=>{if(this.isShapeOfType(i,"group")){let e=this.getSortedChildIdsForParent(i.id);for(let t of e)addShapeById(this.getShape(t))}else{let r=this.getShapeUtil(i),n=this.styleProps[i.type].get(e);if(n){let e={id:i.id,type:i.type,props:{[n]:t}};s.push({util:r,originalShape:i,updatePartial:e})}}};for(let e of i)addShapeById(e);this.updateShapes(s.map(({updatePartial:e})=>e))}return this}registerExternalAssetHandler(e,t){return this.externalAssetContentHandlers[e]=t,this}createTemporaryAssetPreview(e,t){if(this.temporaryAssetPreview.has(e))return this.temporaryAssetPreview.get(e);let i=URL.createObjectURL(t);return this.temporaryAssetPreview.set(e,i),setTimeout(()=>{this.temporaryAssetPreview.delete(e),URL.revokeObjectURL(i)},this.options.temporaryAssetPreviewLifetimeMs),i}getTemporaryAssetPreview(e){return this.temporaryAssetPreview.get(e)}async getAssetForExternalContent(e){return await this.externalAssetContentHandlers[e.type]?.(e)}hasExternalAssetHandler(e){return!!this.externalAssetContentHandlers[e]}registerExternalContentHandler(e,t){return this.externalContentHandlers[e]=t,this}async putExternalContent(e){return this.externalContentHandlers[e.type]?.(e)}async replaceExternalContent(e){return this.externalContentHandlers[e.type]?.(e)}getContentFromCurrentPage(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);if(!t||0===t.length)return;let i=this.getShapeAndDescendantIds(t);return withIsolatedShapes(this,i,e=>{let t=[];for(let i of e){let e=this.getBinding(i);e&&t.push(e)}let s=[],r=[];for(let e of i){let t=this.getShape(e);if(!t)continue;let n=!i.has(t.parentId);if(n){let e=this.getShapePageTransform(t.id),i=e.point();r.push({...t,x:i.x,y:i.y,rotation:e.rotation(),parentId:this.getCurrentPageId()}),s.push(t.id)}else r.push(t)}let n=[],a=new Set;for(let e of r){if(!("assetId"in e.props))continue;let t=e.props.assetId;if(!t||a.has(t))continue;a.add(t);let i=this.getAsset(t);i&&n.push(i)}return{schema:this.store.schema.serialize(),shapes:r,rootShapeIds:s,bindings:t,assets:n}})}async resolveAssetsInContent(e){if(!e)return;let t=[];return await Promise.allSettled(e.assets.map(async e=>{if("image"!==e.type&&"video"!==e.type||e.props.src?.startsWith("data:image")||e.props.src?.startsWith("data:video")||e.props.src?.startsWith("http"))t.push(e);else{let i=(0,eF.v4)(e),s=await this.store.props.assets.resolve(e,{screenScale:1,steppedScreenScale:1,dpr:1,networkEffectiveType:null,shouldResolveToOriginal:!0});i.props.src=await eF.P6.blobToDataUrl(await (0,eF.he)(s).then(e=>e.blob())),t.push(i)}})),e.assets=t,e}putContentOntoCurrentPage(e,t={}){if(this.getIsReadonly())return this;if(!e.schema)throw Error("Could not put content:\ncontent is missing a schema.");let{select:i=!1,preserveIds:s=!1,preservePosition:r=!1}=t,{point:n}=t,a=this.getCurrentPageId(),{rootShapeIds:h}=e,o=[],l=[],d=[],p={store:{...Object.fromEntries(e.assets.map(e=>[e.id,e])),...Object.fromEntries(e.shapes.map(e=>[e.id,e])),...Object.fromEntries(e.bindings?.map(e=>[e.id,e])??[])},schema:e.schema},g=this.store.schema.migrateStoreSnapshot(p);if("error"===g.type)throw Error("Could not put content: could not migrate content");for(let e of Object.values(g.value))switch(e.typeName){case"asset":o.push(e);break;case"shape":l.push(e);break;case"binding":d.push(e)}let u=new Map(s?l.map(e=>[e.id,e.id]):l.map(e=>[e.id,(0,eB.F1)()])),c=new Map(s?d.map(e=>[e.id,e.id]):d.map(e=>[e.id,(0,eB.vI)()])),S=this.getCurrentPageId(),f=1/0,m=[];for(let e of this.getSelectedShapes()){if(0===f)break;let t=this.isShapeOfType(e,"frame"),i=this.getShapeAncestors(e);t&&i.push(e);let s=t?i.length+1:i.length;if(s<f)f=s,m=i,S=t?e.id:e.parentId;else if(s===f){if(m.length!==i.length)throw Error(`Ancestors: ${m.length} !== ${i.length}`);if(0===m.length){S=a;break}S=a;for(let e=0;e<m.length&&i[e]===m[e];e++)S=i[e].id}}let y=!1;if(!(0,eB.r5)(S)){let e=this.getShape(S);if(e){if(this.getViewportPageBounds().includes(this.getShapePageBounds(e))){if(1===h.length){let t=l.find(e=>e.id===h[0]);this.isShapeOfType(e,"frame")&&this.isShapeOfType(t,"frame")&&t.props.w===e?.props.w&&t.props.h===e?.props.h&&(y=!0)}}else S=a}else S=a}y||(y=u.has(S)),y&&(S=this.getShape(S).parentId);let _=this.getHighestIndexForParent(S),P=[],I=l.map(e=>{let t=u.get(e.id),i={...e,id:t};return h.includes(e.id)&&(i.parentId=a,P.push(i)),u.has(i.parentId)?i.parentId=u.get(e.parentId):(h.push(i.id),i.index=_,_=(0,eF._L)(_)),i});if(I.length+this.getCurrentPageShapeIds().size>this.options.maxShapesPerPage)return alertMaxShapes(this),this;let C=d.map(e=>({...e,id:(0,eF.kP)(c.get(e.id)),fromId:(0,eF.kP)(u.get(e.fromId)),toId:(0,eF.kP)(u.get(e.toId))})),w=[],b=[];for(let e of o)this.store.has(e.id)||(("image"===e.type&&e.props.src?.startsWith("data:image")||"video"===e.type&&e.props.src?.startsWith("data:video"))&&(b.push((0,eF.v4)(e)),e.props.src=null),w.push(e));return Promise.allSettled(b.map(async e=>{let t=await (0,ej.B)(e.props.src,e.props.name,e.props.mimeType??"image/png"),i=await this.getAssetForExternalContent({type:"file",file:t,assetId:e.id});if(!i){this.deleteAssets([e.id]);return}this.updateAssets([{...i,id:e.id}])})),this.run(()=>{w.length>0&&this.createAssets(w),this.createShapes(I),this.createBindings(C),i&&this.select(...P.map(e=>e.id)),S!==a&&this.reparentShapes(P.map(e=>e.id),S);let e=I.map(e=>this.getShape(e.id)),t=eD.xu.Common(e.map(e=>this.getShapePageBounds(e)));if(void 0===n){if((0,eB.r5)(S)){let e=this.getViewportPageBounds();n=r||e.includes(eD.xu.From(t))?t.center:e.center}else{let e=this.getShape(S);n=eG._.applyToPoint(this.getShapePageTransform(e),this.getShapeGeometry(e).bounds.center)}}if(1===P.length){let e=P[0];if(this.isShapeOfType(e,"frame"))for(;this.getShapesAtPoint(n).some(t=>this.isShapeOfType(t,"frame")&&t.props.w===e.props.w&&t.props.h===e.props.h);)n.x+=t.w+16}let s=eD.xu.Common((0,eF.oA)(P.map(({id:e})=>this.getShapePageBounds(e)))).center,h=eH.B.Sub(n,s);this.updateShapes(P.map(({id:e})=>{let t=this.getShape(e),i=this.getShapeParentTransform(e).decompose().rotation,s=eH.B.Rot(h,-i);return{id:t.id,type:t.type,x:t.x+s.x,y:t.y+s.y}}))}),this}async getSvgElement(e,t={}){let i=0===e.length?this.getCurrentPageShapeIdsSorted():"string"==typeof e[0]?e:e.map(e=>e.id);if(0!==i.length)return(0,eU.$)(this,i,t)}async getSvgString(e,t={}){let i=await this.getSvgElement(e,t);if(!i)return;let s=new XMLSerializer;return{svg:s.serializeToString(i.svg),width:i.width,height:i.height}}async getSvg(e,t={}){let i=await this.getSvgElement(e,t);if(i)return i.svg}async toImage(e,t={}){let i={format:"png",scale:1,pixelRatio:"svg"===t.format?void 0:2,...t},s=await this.getSvgString(e,i);if(!s)throw Error("Could not create SVG");switch(i.format){case"svg":return{blob:new Blob([s.svg],{type:"image/svg+xml"}),width:s.width,height:s.height};case"jpeg":case"png":case"webp":{let e=await (0,eR.u)(s.svg,{type:i.format,quality:i.quality,pixelRatio:i.pixelRatio,width:s.width,height:s.height});if(!e)throw Error("Could not construct image.");return{blob:e,width:s.width,height:s.height}}default:(0,eF.iP)(i.format)}}_updateInputsFromEvent(e){let{pointerVelocity:t,previousScreenPoint:i,previousPagePoint:s,currentScreenPoint:r,currentPagePoint:n,originScreenPoint:a,originPagePoint:h}=this.inputs,{screenBounds:o}=this.store.unsafeGetWithoutCapture(eB.PQ),{x:l,y:d,z:p}=(0,eb.dy)(()=>this.getCamera()),g=e.point.x-o.x,u=e.point.y-o.y,c=e.point.z??.5;i.setTo(r),s.setTo(n),r.set(g,u);let S=g/p-l,f=u/p-d;isFinite(S)&&isFinite(f)&&n.set(S,f,c),this.inputs.isPen="pointer"===e.type&&e.isPen,("pointer_down"===e.name||this.inputs.isPinching)&&(t.set(0,0),a.setTo(r),h.setTo(n)),this.run(()=>{this.store.put([{id:eB.LV,typeName:"pointer",x:n.x,y:n.y,lastActivityTimestamp:"pointer"===e.type&&e.pointerId===eO.CK.CAMERA_MOVE?this.store.unsafeGetWithoutCapture(eB.LV)?.lastActivityTimestamp??this._tickManager.now:this._tickManager.now,meta:{}}])},{history:"ignore"})}cancel(){return this.dispatch({type:"misc",name:"cancel"}),this}interrupt(){return this.dispatch({type:"misc",name:"interrupt"}),this}complete(){return this.dispatch({type:"misc",name:"complete"}),this}focus({focusContainer:e=!0}={}){return this.getIsFocused()||(e&&this.focusManager.focus(),this.updateInstanceState({isFocused:!0})),this}blur({blurContainer:e=!0}={}){return this.getIsFocused()&&(e?this.focusManager.blur():this.complete(),this.updateInstanceState({isFocused:!1})),this}getIsFocused(){return this.getInstanceState().isFocused}getIsReadonly(){return this.getInstanceState().isReadonly}getSnapshot(){return(0,ev.v)(this.store)}loadSnapshot(e,t){return(0,ev.w)(this.store,e,t),this}_zoomToFitPageContentAt100Percent(){let e=this.getCurrentPageBounds();e&&this.zoomToBounds(e,{immediate:!0,targetZoom:this.getBaseZoom()})}_navigateToDeepLink(e){this.run(()=>{switch(e.type){case"page":{let t=this.getPage(e.pageId);t&&this.setCurrentPage(t),this._zoomToFitPageContentAt100Percent();return}case"shapes":{let t=(0,eF.oA)(e.shapeIds.map(e=>this.getShape(e))),i={};for(let e of t){let t=this.getAncestorPageId(e);t&&(i[t]??=[],i[t].push(e))}let[s,r]=Object.entries(i).sort(([e,t],[i,s])=>s.length-t.length)[0]??["",[]];if(s&&r.length){this.setCurrentPage(s);let e=eD.xu.Common(r.map(e=>this.getShapePageBounds(e)));this.zoomToBounds(e,{immediate:!0,targetZoom:this.getBaseZoom()})}else this._zoomToFitPageContentAt100Percent();return}case"viewport":if(e.pageId){if(!this.getPage(e.pageId)){this._zoomToFitPageContentAt100Percent();return}this.setCurrentPage(e.pageId)}this.zoomToBounds(e.bounds,{immediate:!0,inset:0});return;default:(0,eF.iP)(e)}})}navigateToDeepLink(e){if(e&&"type"in e)return this._navigateToDeepLink(e),this;let t=new URL(e?.url??window.location.href),i=t.searchParams.get(e?.param??"d");if(!i)return this._zoomToFitPageContentAt100Percent(),this;try{this._navigateToDeepLink((0,e$.Y)(i))}catch(e){console.warn(e),this._zoomToFitPageContentAt100Percent()}return this}createDeepLink(e){let t=new URL(e?.url??window.location.href);return t.searchParams.set(e?.param??"d",(0,e$.y)(e?.to??{type:"viewport",pageId:1===this.options.maxPages?void 0:this.getCurrentPageId(),bounds:this.getViewportPageBounds()})),t}registerDeepLinkListener(e){if(e?.getUrl&&!e?.onChange)throw Error("[tldraw:urlStateSync] If you specify getUrl, you must also specify the onChange callback.");let t=(0,eb.Fl)("url with state",()=>{let t=e?.getUrl?.(this)??window.location.href,i=this.createDeepLink({param:e?.param,url:t,to:e?.getTarget?.(this)});return i.toString()}),i=e?.onChange??(()=>{let t=this.createDeepLink({param:e?.param,to:e?.getTarget?.(this)});window.history.replaceState({},document.title,t.toString())}),s=(0,eF.Ds)(e=>e(),e?.debounceMs??500),r=(0,eb.Ym)("update url on state change",()=>i(new URL(t.get()),this),{scheduleEffect:s});return()=>{r(),s.cancel()}}cancelDoubleClick(){this._clickManager.cancelDoubleClickTimeout()}_setShiftKeyTimeout(){this.inputs.shiftKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Shift",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,metaKey:this.inputs.metaKey,accelKey:(0,e0.q)(this.inputs),code:"ShiftLeft"})}_setAltKeyTimeout(){this.inputs.altKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Alt",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,metaKey:this.inputs.metaKey,accelKey:(0,e0.q)(this.inputs),code:"AltLeft"})}_setCtrlKeyTimeout(){this.inputs.ctrlKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Ctrl",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,metaKey:this.inputs.metaKey,accelKey:(0,e0.q)(this.inputs),code:"ControlLeft"})}_setMetaKeyTimeout(){this.inputs.metaKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Meta",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,metaKey:this.inputs.metaKey,accelKey:(0,e0.q)(this.inputs),code:"MetaLeft"})}dispatch(e){return this._pendingEventsForNextTick.push(e),"pointer"===e.type&&"pointer_move"===e.name||"wheel"===e.type||"pinch"===e.type||this._flushEventsForTick(0),this}_flushEventsForTick(e){this.run(()=>{if(this._pendingEventsForNextTick.length>0){let e=[...this._pendingEventsForNextTick];for(let t of(this._pendingEventsForNextTick.length=0,e))this._flushEventForTick(t)}e>0&&this.root.handleEvent({type:"misc",name:"tick",elapsed:e}),this.scribbles.tick(e)})}_flushEventForTick(e){if(this.getCrashingError())return this;this.emit("before-event",e);let{inputs:t}=this,{type:i}=e;if("misc"===e.type){("cancel"===e.name||"complete"===e.name)&&(this.inputs.isDragging=!1,this.inputs.isPanning&&(this.inputs.isPanning=!1,this.inputs.isSpacebarPanning=!1,this.setCursor({type:this._prevCursor,rotation:0}))),this.root.handleEvent(e);return}e.shiftKey?(clearTimeout(this._shiftKeyTimeout),this._shiftKeyTimeout=-1,t.shiftKey=!0):!e.shiftKey&&t.shiftKey&&-1===this._shiftKeyTimeout&&(this._shiftKeyTimeout=this.timers.setTimeout(this._setShiftKeyTimeout,150)),e.altKey?(clearTimeout(this._altKeyTimeout),this._altKeyTimeout=-1,t.altKey=!0):!e.altKey&&t.altKey&&-1===this._altKeyTimeout&&(this._altKeyTimeout=this.timers.setTimeout(this._setAltKeyTimeout,150)),e.ctrlKey?(clearTimeout(this._ctrlKeyTimeout),this._ctrlKeyTimeout=-1,t.ctrlKey=!0):!e.ctrlKey&&t.ctrlKey&&-1===this._ctrlKeyTimeout&&(this._ctrlKeyTimeout=this.timers.setTimeout(this._setCtrlKeyTimeout,150)),e.metaKey?(clearTimeout(this._metaKeyTimeout),this._metaKeyTimeout=-1,t.metaKey=!0):!e.metaKey&&t.metaKey&&-1===this._metaKeyTimeout&&(this._metaKeyTimeout=this.timers.setTimeout(this._setMetaKeyTimeout,150));let{originPagePoint:s,currentPagePoint:r}=t;t.isPointing||(t.isDragging=!1);let n=this.store.unsafeGetWithoutCapture(eB.PQ),a=this.store.get(this._getCurrentPageStateId()),h=this._cameraOptions.__unsafe__getWithoutCapture();switch(i){case"pinch":if(h.isLocked)return;switch(clearTimeout(this._longPressTimeout),this._updateInputsFromEvent(e),e.name){case"pinch_start":if(t.isPinching)return;t.isEditing||(this._pinchStart=this.getCamera().z,this._selectedShapeIdsAtPointerDown.length||(this._selectedShapeIdsAtPointerDown=[...a.selectedShapeIds]),this._didPinch=!0,t.isPinching=!0,this.interrupt());return;case"pinch":{if(!t.isPinching)return;let{point:{z:i=1},delta:{x:s,y:r}}=e,{x:a,y:o}=eH.B.SubXY(e.point,n.screenBounds.x,n.screenBounds.y);this.stopCameraAnimation(),n.followingUserId&&this.stopFollowingUser();let{x:l,y:d,z:p}=(0,eb.dy)(()=>this.getCamera()),{panSpeed:g}=h;this._setCamera(new eH.B(l+s*g/p-a/p+a/i,d+r*g/p-o/p+o/i,i),{immediate:!0});return}case"pinch_end":{if(!t.isPinching)return this;t.isPinching=!1;let{_selectedShapeIdsAtPointerDown:e}=this;this.setSelectedShapes(this._selectedShapeIdsAtPointerDown),this._selectedShapeIdsAtPointerDown=[],this._didPinch&&(this._didPinch=!1,e.length>0&&this.once("tick",()=>{this._didPinch||this.setSelectedShapes(e)}));return}}case"wheel":{if(h.isLocked)return;this._updateInputsFromEvent(e);let{panSpeed:t,zoomSpeed:i,wheelBehavior:s}=h;if("none"!==s){this.stopCameraAnimation(),n.followingUserId&&this.stopFollowingUser();let{x:r,y:a,z:h}=(0,eb.dy)(()=>this.getCamera()),{x:o,y:l,z:d=0}=e.delta,p=s;switch(e.ctrlKey&&(p="pan"===s?"zoom":"pan"),p){case"zoom":{let{x:e,y:t}=this.inputs.currentScreenPoint,n=d;"zoom"===s&&(n=Math.abs(l)>10?10*Math.sign(l)/100:l/100);let o=h+(n??0)*i*h;this._setCamera(new eH.B(r+e/o-e/h,a+t/o-t/h,o),{immediate:!0}),this.maybeTrackPerformance("Zooming");return}case"pan":this._setCamera(new eH.B(r+o*t/h,a+l*t/h,h),{immediate:!0}),this.maybeTrackPerformance("Panning");return}}break}case"pointer":{if(t.isPinching)return;this._updateInputsFromEvent(e);let{isPen:i}=e,{isPenMode:a}=n;switch(e.name){case"pointer_down":if(a&&!i)return;if(this.inputs.isPanning||(this._longPressTimeout=this.timers.setTimeout(()=>{let t=this.getViewportScreenBounds();this.dispatch({...e,point:this.inputs.originScreenPoint.clone().addXY(t.x,t.y),name:"long_press"})},this.options.longPressDurationMs)),this._selectedShapeIdsAtPointerDown=this.getSelectedShapeIds(),e.button===eO.QN&&(this.capturedPointerId=e.pointerId),t.buttons.add(e.button),t.isPointing=!0,t.isDragging=!1,!a&&i&&this.updateInstanceState({isPenMode:!0}),e.button===eO.an?(this._restoreToolId=this.getCurrentToolId(),this.complete(),this.setCurrentTool("eraser")):e.button===eO.sz&&(this.inputs.isPanning||(this._prevCursor=this.getInstanceState().cursor.type),this.inputs.isPanning=!0,clearTimeout(this._longPressTimeout)),this.inputs.isPanning)return this.stopCameraAnimation(),this.setCursor({type:"grabbing",rotation:0}),this;break;case"pointer_move":{if(!i&&a)return;let{x:e,y:h,z:o}=(0,eb.dy)(()=>this.getCamera());if(this.inputs.isPanning&&this.inputs.isPointing){let{currentScreenPoint:t,previousScreenPoint:i}=this.inputs,s=eH.B.Sub(t,i);this.setCamera(new eH.B(e+s.x/o,h+s.y/o,o),{immediate:!0}),this.maybeTrackPerformance("Panning");return}t.isPointing&&!t.isDragging&&eH.B.Dist2(s,r)*this.getZoomLevel()>(n.isCoarsePointer?this.options.coarseDragDistanceSquared:this.options.dragDistanceSquared)/o&&(t.isDragging=!0,clearTimeout(this._longPressTimeout));break}case"pointer_up":if(t.isDragging=!1,t.isPointing=!1,clearTimeout(this._longPressTimeout),t.buttons.delete(e.button),n.isPenMode&&!i)return;if(this.capturedPointerId===e.pointerId&&(this.capturedPointerId=null,e.button=0),t.isPanning){t.keys.has("Space")||(t.isPanning=!1,t.isSpacebarPanning=!1);let i=this.inputs.pointerVelocity,s=Math.min(2,i.len());switch(e.button){case eO.QN:this.setCursor({type:"grab",rotation:0});break;case eO.sz:this.inputs.keys.has(" ")?this.setCursor({type:"grab",rotation:0}):this.setCursor({type:this._prevCursor,rotation:0})}s>0&&this.slideCamera({speed:s,direction:i})}else e.button===eO.an&&(this.complete(),this.setCurrentTool(this._restoreToolId))}break}case"keyboard":switch("ShiftRight"===e.key&&(e.key="ShiftLeft"),"AltRight"===e.key&&(e.key="AltLeft"),"ControlRight"===e.code&&(e.code="ControlLeft"),"MetaRight"===e.code&&(e.code="MetaLeft"),e.name){case"key_down":if(t.keys.add(e.code),"Space"!==e.code||e.ctrlKey||(this.inputs.isPanning||(this._prevCursor=n.cursor.type),this.inputs.isPanning=!0,this.inputs.isSpacebarPanning=!0,clearTimeout(this._longPressTimeout),this.setCursor({type:this.inputs.isPointing?"grabbing":"grab",rotation:0})),this.inputs.isSpacebarPanning){let t;switch(e.code){case"ArrowUp":t=new eH.B(0,-1);break;case"ArrowRight":t=new eH.B(1,0);break;case"ArrowDown":t=new eH.B(0,1);break;case"ArrowLeft":t=new eH.B(-1,0)}if(t){let e=this.getViewportPageBounds(),i=e.clone().translate(t.mulV({x:e.w,y:e.h}));this._animateToViewport(i,{animation:{duration:320}})}}break;case"key_up":t.keys.delete(e.code),"Space"===e.code&&(this.inputs.buttons.has(eO.sz)||(this.inputs.isPanning=!1,this.inputs.isSpacebarPanning=!1,this.setCursor({type:this._prevCursor,rotation:0})))}}if("pointer"===e.type){e.button===eO.sz?e.name="middle_click":e.button===eO.Hs&&(e.name="right_click");let{isPenMode:t}=this.store.unsafeGetWithoutCapture(eB.PQ);if(e.isPen===t){let t=this._clickManager.handlePointerEvent(e);if(e.name!==t.name){this.root.handleEvent(e),this.emit("event",e),this.root.handleEvent(t),this.emit("event",t);return}}}return this.root.handleEvent(e),this.emit("event",e),"pointer"===e.type&&"pointer_down"===e.name&&this.menus.clearOpenMenus(),this}maybeTrackPerformance(e){eQ.hR.measurePerformance.get()&&(this.performanceTracker.isStarted()?clearTimeout(this.performanceTrackerTimeout):this.performanceTracker.start(e),this.performanceTrackerTimeout=this.timers.setTimeout(()=>{this.performanceTracker.stop()},50))}};function alertMaxShapes(e,t=e.getCurrentPageId()){let i=e.getPage(t).name;e.emit("max-shapes",{name:i,pageId:t,count:e.options.maxShapesPerPage})}function applyPartialToRecordWithProps(e,t){if(!t)return e;let i=null,s=Object.entries(t);for(let t=0,r=s.length;t<r;t++){let[r,n]=s[t];if(void 0!==n&&"id"!==r&&"type"!==r&&"typeName"!==r&&n!==e[r]){if(i||(i={...e}),"props"===r||"meta"===r){for(let[t,s]of(i[r]={...e[r]},Object.entries(n)))i[r][t]=s;continue}i[r]=n}}return i||e}function withIsolatedShapes(e,t,i){let s;if(e.run(()=>{let r=e.store.extractingChanges(()=>{let r=new Set,n=new Set;for(let i of t){let s=e.getShape(i);if(s)for(let s of e.getBindingsInvolvingShape(i)){let e=t.has(s.fromId),i=t.has(s.toId);if(e&&i){r.add(s.id);continue}e&&i||n.add(s.id)}}e.deleteBindings([...n],{isolateShapes:!0});try{s=eF.x4.ok(i(r))}catch(e){s=eF.x4.err(e)}});e.store.applyDiff((0,eT.kJ)(r),{runCallbacks:!1})},{history:"ignore"}),s.ok)return s.value;throw s.error}function getCameraFitXFitY(e,t){if(!t.constraints)throw Error("Should have constraints here");let{padding:{x:i,y:s}}=t.constraints,r=e.getViewportScreenBounds(),n=eD.xu.From(t.constraints.bounds),a=(r.w-2*i)/n.w,h=(r.h-2*s)/n.h;return{zx:a,zy:h}}__decorateElement(ex=[,,,to(ew?.[__knownSymbol("metadata")]??null)],1,"getIsShapeHiddenCache",eC,Editor),__decorateElement(ex,1,"getCanUndo",eI,Editor),__decorateElement(ex,1,"getCanRedo",eP,Editor),__decorateElement(ex,1,"getPath",e_,Editor),__decorateElement(ex,1,"getCurrentTool",ey,Editor),__decorateElement(ex,1,"getCurrentToolId",em,Editor),__decorateElement(ex,1,"getDocumentSettings",ef,Editor),__decorateElement(ex,1,"getInstanceState",eS,Editor),__decorateElement(ex,1,"getOpenMenus",ec,Editor),__decorateElement(ex,1,"getIsMenuOpen",eu,Editor),__decorateElement(ex,1,"getPageStates",eg,Editor),__decorateElement(ex,1,"_getPageStatesQuery",ep,Editor),__decorateElement(ex,1,"getCurrentPageState",ed,Editor),__decorateElement(ex,1,"_getCurrentPageStateId",el,Editor),__decorateElement(ex,1,"getSelectedShapeIds",eo,Editor),__decorateElement(ex,1,"getSelectedShapes",eh,Editor),__decorateElement(ex,1,"getCurrentPageShapesInReadingOrder",ea,Editor),__decorateElement(ex,1,"getOnlySelectedShapeId",en,Editor),__decorateElement(ex,1,"getOnlySelectedShape",er,Editor),__decorateElement(ex,1,"getSelectionPageBounds",es,Editor),__decorateElement(ex,1,"getSelectionRotation",ei,Editor),__decorateElement(ex,1,"getSelectionRotatedPageBounds",et,Editor),__decorateElement(ex,1,"getSelectionRotatedScreenBounds",ee,Editor),__decorateElement(ex,1,"getFocusedGroupId",J,Editor),__decorateElement(ex,1,"getFocusedGroup",$,Editor),__decorateElement(ex,1,"getEditingShapeId",Q,Editor),__decorateElement(ex,1,"getEditingShape",j,Editor),__decorateElement(ex,1,"getRichTextEditor",q,Editor),__decorateElement(ex,1,"getHoveredShapeId",W,Editor),__decorateElement(ex,1,"getHoveredShape",X,Editor),__decorateElement(ex,1,"getHintingShapeIds",Y,Editor),__decorateElement(ex,1,"getHintingShape",N,Editor),__decorateElement(ex,1,"getErasingShapeIds",Z,Editor),__decorateElement(ex,1,"getErasingShapes",H,Editor),__decorateElement(ex,1,"_unsafe_getCameraId",G,Editor),__decorateElement(ex,1,"getCamera",D,Editor),__decorateElement(ex,1,"getViewportPageBoundsForFollowing",V,Editor),__decorateElement(ex,1,"getCameraForFollowing",z,Editor),__decorateElement(ex,1,"getZoomLevel",K,Editor),__decorateElement(ex,1,"getViewportScreenBounds",L,Editor),__decorateElement(ex,1,"getViewportScreenCenter",R,Editor),__decorateElement(ex,1,"getViewportPageBounds",U,Editor),__decorateElement(ex,1,"_getCollaboratorsQuery",O,Editor),__decorateElement(ex,1,"getCollaborators",M,Editor),__decorateElement(ex,1,"getCollaboratorsOnCurrentPage",A,Editor),__decorateElement(ex,1,"getRenderingShapes",k,Editor),__decorateElement(ex,1,"_getAllPagesQuery",v,Editor),__decorateElement(ex,1,"getPages",E,Editor),__decorateElement(ex,1,"getCurrentPageId",F,Editor),__decorateElement(ex,1,"getCurrentPageShapeIdsSorted",B,Editor),__decorateElement(ex,1,"_getAllAssetsQuery",T,Editor),__decorateElement(ex,1,"_getShapeHandlesCache",b,Editor),__decorateElement(ex,1,"_getShapePageTransformCache",w,Editor),__decorateElement(ex,1,"_getShapePageBoundsCache",C,Editor),__decorateElement(ex,1,"_getShapeClipPathCache",I,Editor),__decorateElement(ex,1,"_getShapeMaskCache",P,Editor),__decorateElement(ex,1,"_getShapeMaskedPageBoundsCache",_,Editor),__decorateElement(ex,1,"getNotVisibleShapes",y,Editor),__decorateElement(ex,1,"getCulledShapes",m,Editor),__decorateElement(ex,1,"getCurrentPageBounds",f,Editor),__decorateElement(ex,1,"getCurrentPageShapes",S,Editor),__decorateElement(ex,1,"getCurrentPageShapesSorted",c,Editor),__decorateElement(ex,1,"getCurrentPageRenderingShapesSorted",u,Editor),__decorateElement(ex,1,"_getBindingsIndexCache",g,Editor),__decorateElement(ex,1,"_getSelectionSharedStyles",p,Editor),__decorateElement(ex,1,"getSharedStyles",d,Editor),__decorateElement(ex,1,"getSharedOpacity",l,Editor),__decorateElement(ex,1,"getIsFocused",o,Editor),__decorateElement(ex,1,"getIsReadonly",h,Editor),__decorateElement(ex,1,"_setShiftKeyTimeout",a,Editor),__decorateElement(ex,1,"_setAltKeyTimeout",n,Editor),__decorateElement(ex,1,"_setCtrlKeyTimeout",r,Editor),__decorateElement(ex,1,"_setMetaKeyTimeout",s,Editor),__decoratorMetadata(ex,Editor)}}]);