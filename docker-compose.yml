version: '3.8'

services:
  # Infrastructure Services
  postgres:
    image: postgres:15-alpine
    container_name: sallie-postgres
    environment:
      POSTGRES_DB: sallie
      POSTGRES_USER: sallie
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-sallie123}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/shared/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - sallie-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sallie"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:7-alpine
    container_name: sallie-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - sallie-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  kafka:
    image: confluentinc/cp-kafka:latest
    container_name: sallie-kafka
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,PLAINTEXT_HOST://kafka:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    ports:
      - "9092:9092"
      - "29092:29092"
    depends_on:
      - zookeeper
    networks:
      - sallie-network
    restart: unless-stopped

  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    container_name: sallie-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - sallie-network
    restart: unless-stopped

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: sallie-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - "xpack.security.enrollment.enabled=false"
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - sallie-network
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    container_name: sallie-minio
    environment:
      MINIO_ROOT_USER: sallie
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD:-sallie123}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - sallie-network
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    container_name: sallie-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - sallie-network
    restart: unless-stopped

  # AI/ML Services
  ollama:
    image: ollama/ollama:latest
    container_name: sallie-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    networks:
      - sallie-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G

  # Core Backend Services
  api-gateway:
    build:
      context: ./backend/services/api-gateway
      dockerfile: Dockerfile
    container_name: sallie-api-gateway
    ports:
      - "8742:8742"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8742
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=sallie
      - POSTGRES_USER=sallie
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-sallie123}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - KAFKA_BROKERS=kafka:9092
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=sallie
      - MINIO_SECRET_KEY=${MINIO_PASSWORD:-sallie123}
      - OLLAMA_URL=http://ollama:11434
      - QDRANT_URL=http://qdrant:6333
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-key}
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000}
    depends_on:
      - postgres
      - redis
      - kafka
      - elasticsearch
      - minio
      - ollama
      - qdrant
    networks:
      - sallie-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8742/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  auth-service:
    build:
      context: ./backend/services/auth-service
      dockerfile: Dockerfile
    container_name: sallie-auth-service
    ports:
      - "8743:8743"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8743
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=sallie
      - POSTGRES_USER=sallie
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-sallie123}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-key}
      - KINSHIP_ENABLED=true
      - SMTP_HOST=${SMTP_HOST:-localhost}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
    depends_on:
      - postgres
      - redis
    networks:
      - sallie-network
    restart: unless-stopped

  chat-service:
    build:
      context: ./backend/services/chat-service
      dockerfile: Dockerfile
    container_name: sallie-chat-service
    ports:
      - "8744:8744"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8744
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=sallie
      - POSTGRES_USER=sallie
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-sallie123}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - KAFKA_BROKERS=kafka:9092
      - LIMBIC_ENGINE_URL=http://limbic-engine:8750
      - MEMORY_SERVICE_URL=http://memory-service:8751
      - AGENCY_SERVICE_URL=http://agency-service:8752
    depends_on:
      - postgres
      - redis
      - kafka
      - limbic-engine
      - memory-service
      - agency-service
    networks:
      - sallie-network
    restart: unless-stopped

  analytics-service:
    build:
      context: ./backend/services/analytics-service
      dockerfile: Dockerfile
    container_name: sallie-analytics-service
    ports:
      - "8745:8745"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8745
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=sallie
      - POSTGRES_USER=sallie
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-sallie123}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - KAFKA_BROKERS=kafka:9092
    depends_on:
      - postgres
      - redis
      - elasticsearch
      - kafka
    networks:
      - sallie-network
    restart: unless-stopped

  notifications-service:
    build:
      context: ./backend/services/notifications-service
      dockerfile: Dockerfile
    container_name: sallie-notifications-service
    ports:
      - "8746:8746"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8746
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=sallie
      - POSTGRES_USER=sallie
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-sallie123}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - KAFKA_BROKERS=kafka:9092
      - SMTP_HOST=${SMTP_HOST:-localhost}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - GHOST_INTERFACE_ENABLED=true
    depends_on:
      - postgres
      - redis
      - kafka
    networks:
      - sallie-network
    restart: unless-stopped

  file-service:
    build:
      context: ./backend/services/file-service
      dockerfile: Dockerfile
    container_name: sallie-file-service
    ports:
      - "8747:8747"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8747
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=sallie
      - MINIO_SECRET_KEY=${MINIO_PASSWORD:-sallie123}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - WATCH_PATHS=${WATCH_PATHS:-./work,./projects,./documents}
      - BACKUP_ENABLED=true
    depends_on:
      - minio
      - redis
    networks:
      - sallie-network
    restart: unless-stopped

  ai-service:
    build:
      context: ./backend/services/ai-service
      dockerfile: Dockerfile
    container_name: sallie-ai-service
    ports:
      - "8748:8748"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8748
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OLLAMA_URL=http://ollama:11434
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DEFAULT_MODEL=${DEFAULT_MODEL:-llama2}
      - FALLBACK_MODEL=${FALLBACK_MODEL:-mistral}
    depends_on:
      - redis
      - ollama
    networks:
      - sallie-network
    restart: unless-stopped

  websocket-service:
    build:
      context: ./backend/services/websocket-service
      dockerfile: Dockerfile
    container_name: sallie-websocket-service
    ports:
      - "8749:8749"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8749
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - KAFKA_BROKERS=kafka:9092
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-key}
      - MAX_CONNECTIONS=${MAX_CONNECTIONS:-1000}
    depends_on:
      - redis
      - kafka
    networks:
      - sallie-network
    restart: unless-stopped

  # Extended Sallie Services
  limbic-engine:
    build:
      context: ./backend/services/limbic-engine
      dockerfile: Dockerfile
    container_name: sallie-limbic-engine
    ports:
      - "8750:8750"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8750
      - LIMBIC_BOOTSTRAP_TRUST=0.5
      - LIMBIC_BOOTSTRAP_WARMTH=0.6
      - LIMBIC_BOOTSTRAP_AROUSAL=0.7
      - LIMBIC_BOOTSTRAP_VALENCE=0.6
      - LIMBIC_BOOTSTRAP_EMPATHY=0.5
      - LIMBIC_BOOTSTRAP_INTUITION=0.6
      - LIMBIC_BOOTSTRAP_CREATIVITY=0.5
      - LIMBIC_BOOTSTRAP_WISDOM=0.5
      - LIMBIC_BOOTSTRAP_HUMOR=0.4
      - AROUSAL_DECAY_PER_DAY=0.15
      - AROUSAL_FLOOR=0.2
      - VALENCE_DRIFT_PER_HOUR=0.1
      - VALENCE_BASELINE=0.5
      - SLUMBER_THRESHOLD=0.3
      - CRISIS_THRESHOLD=0.3
      - DOOR_SLAM_THRESHOLD=0.2
      - ELASTIC_MODE_TRIGGER=0.8
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    networks:
      - sallie-network
    restart: unless-stopped

  memory-service:
    build:
      context: ./backend/services/memory-service
      dockerfile: Dockerfile
    container_name: sallie-memory-service
    ports:
      - "8751:8751"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8751
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_COLLECTION=sallie_memories
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - EMBEDDING_MODEL=text-embedding-ada-002
      - EMBEDDING_DIMENSION=1536
      - SEARCH_LIMIT_DEFAULT=10
      - SEARCH_THRESHOLD_DEFAULT=0.7
      - SALIENCE_DECAY_RATE=0.01
      - FRESHNESS_WEIGHT=0.2
      - DIVERSITY_WEIGHT=0.1
      - MRR_LAMBDA=0.5
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - qdrant
      - redis
    networks:
      - sallie-network
    restart: unless-stopped

  agency-service:
    build:
      context: ./backend/services/agency-service
      dockerfile: Dockerfile
    container_name: sallie-agency-service
    ports:
      - "8752:8752"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8752
      - WHITELIST_PATH=./work
      - WHITELIST_PATH2=./projects
      - WHITELIST_PATH3=./documents
      - BLACKLIST_PATH=./secrets
      - BLACKLIST_PATH2=./.ssh
      - BLACKLIST_PATH3=./.gnupg
      - SANDBOX_PATH=./progeny_root/drafts
      - AUTO_BACKUP_ENABLED=true
      - GIT_INTEGRATION_ENABLED=true
      - MAX_CONCURRENT_ACTIONS=5
      - ACTION_TIMEOUT_SECONDS=300
      - ROLLBACK_RETENTION_DAYS=30
      - DOOR_SLAM_THRESHOLD=0.2
      - MORAL_FRICTION_ENABLED=true
      - TIER4_ENABLED=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    networks:
      - sallie-network
    restart: unless-stopped

  communication-service:
    build:
      context: ./backend/services/communication-service
      dockerfile: Dockerfile
    container_name: sallie-communication-service
    ports:
      - "8753:8753"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8753
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - KAFKA_BROKERS=kafka:9092
      - SMTP_HOST=${SMTP_HOST:-localhost}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - WHISPER_MODEL=${WHISPER_MODEL:-base}
      - PIPER_MODEL=${PIPER_MODEL:-en_US-lessac-medium}
      - WAKE_WORD_MODEL=${WAKE_WORD_MODEL:-progeny}
      - VOICE_ENABLED=true
      - EMAIL_ENABLED=true
      - FILE_INTERFACE_ENABLED=true
    depends_on:
      - redis
      - kafka
    networks:
      - sallie-network
    restart: unless-stopped

  sensor-array-service:
    build:
      context: ./backend/services/sensor-array-service
      dockerfile: Dockerfile
    container_name: sallie-sensor-array-service
    ports:
      - "8754:8754"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8754
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - WATCH_PATHS=./work,./projects,./documents
      - REFRACTORY_PERIOD_HOURS=24
      - SYSTEM_LOAD_THRESHOLD=0.8
      - MEMORY_USAGE_THRESHOLD=0.9
      - PATTERN_DETECTION_ENABLED=true
      - WORKLOAD_SPIKE_THRESHOLD=10
      - ABANDONMENT_THRESHOLD_DAYS=7
      - FOCUS_SHIFT_DETECTION=true
      - STRESS_DETECTION_ENABLED=true
      - PROACTIVE_ENGAGEMENT_ENABLED=true
    depends_on:
      - redis
    networks:
      - sallie-network
    restart: unless-stopped

  genesis-flow-service:
    build:
      context: ./backend/services/genesis-flow-service
      dockerfile: Dockerfile
    container_name: sallie-genesis-flow-service
    ports:
      - "8755:8755"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8755
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=sallie
      - POSTGRES_USER=sallie
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-sallie123}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - HERITAGE_PATH=./progeny_root/heritage
      - DREAM_CYCLE_ENABLED=true
      - DREAM_CYCLE_HOUR=2
      - HYPOTHESIS_EXTRACTION_ENABLED=true
      - ACTIVE_VETO_ENABLED=true
      - HERITAGE_PROMOTION_ENABLED=true
      - CONFLICT_DETECTION_ENABLED=true
      - CONDITIONAL_BELIEF_SYNTHESIS_ENABLED=true
      - ELASTIC_MODE_ENABLED=true
    depends_on:
      - postgres
      - redis
    networks:
      - sallie-network
    restart: unless-stopped

  heritage-service:
    build:
      context: ./backend/services/heritage-service
      dockerfile: Dockerfile
    container_name: sallie-heritage-service
    ports:
      - "8756:8756"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8756
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=sallie
      - POSTGRES_USER=sallie
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-sallie123}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - HERITAGE_PATH=./progeny_root/heritage
      - BACKUP_ENABLED=true
      - BACKUP_INTERVAL_HOURS=24
      - VERSIONING_ENABLED=true
      - KINSHIP_ISOLATION_ENABLED=true
      - DNA_SPLIT_STORAGE=true
      - LEARNED_BELIEFS_ENABLED=true
      - PREFERENCES_STORAGE=true
    depends_on:
      - postgres
      - redis
    networks:
      - sallie-network
    restart: unless-stopped

  convergence-service:
    build:
      context: ./backend/services/convergence-service
      dockerfile: Dockerfile
    container_name: sallie-convergence-service
    ports:
      - "8757:8757"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8757
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=sallie
      - POSTGRES_USER=sallie
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-sallie123}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CONVERGENCE_QUESTIONS_PATH=./shared/convergence/questions.json
      - ELASTIC_MODE_ENABLED=true
      - MIRROR_TEST_ENABLED=true
      - DYNAMIC_Q13_ENABLED=true
      - RESONANCE_DETECTION_ENABLED=true
      - 14_QUESTIONS_ENABLED=true
      - EXTRACTION_PROMPTS_ENABLED=true
    depends_on:
      - postgres
      - redis
    networks:
      - sallie-network
    restart: unless-stopped

  prism-dashboard-service:
    build:
      context: ./backend/services/prism-dashboard-service
      dockerfile: Dockerfile
    container_name: sallie-prism-dashboard-service
    ports:
      - "8758:8758"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=8758
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=sallie
      - POSTGRES_USER=sallie
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-sallie123}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - LIMBIC_ENGINE_URL=http://limbic-engine:8750
      - MEMORY_SERVICE_URL=http://memory-service:8751
      - AGENCY_SERVICE_URL=http://agency-service:8752
      - HERITAGE_SERVICE_URL=http://heritage-service:8756
      - GENESIS_FLOW_URL=http://genesis-flow-service:8755
      - THOUGHTS_LOG_ENABLED=true
      - LIMBIC_VISUALIZATION_ENABLED=true
      - HERITAGE_BROWSER_ENABLED=true
      - REAL_TIME_UPDATES_ENABLED=true
    depends_on:
      - postgres
      - redis
      - elasticsearch
      - limbic-engine
      - memory-service
      - agency-service
      - heritage-service
      - genesis-flow-service
    networks:
      - sallie-network
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  elasticsearch_data:
    driver: local
  minio_data:
    driver: local
  qdrant_data:
    driver: local
  ollama_data:
    driver: local
  omnis_data:
    driver: local

networks:
  sallie-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
